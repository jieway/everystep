# 概述

* [cs144.github.io](https://github.com/CS144/cs144.github.io) Github 仓库地址。
* [cs144.github.io](https://weijiew.gitee.io/cs144.github.io/) 我这里无法访问课程的在线页面，似乎被墙了。于是做了一个备份，部署到了 Gitee 上面，国内访问的话速度会比较快！
* [CS144 计算机网络介绍](https://www.bilibili.com/video/av96841516) B站一个机翻版的完结视频，2019 秋季，比较新。
* [TCP-Lab](https://github.com/huangrt01/TCP-Lab) 参考记录。
* [gcidart/cs144](https://github.com/gcidart/cs144) 一位印度大哥的通关实验。

# 实验

* Lab 0: networking warmup
* Lab 1: stitching substrings into a byte stream
* Lab 2: the TCP receiver
* Lab 3: the TCP sender
* Lab 4: the TCP connection
* Lab 5: the network interface
* Lab 6: the IP router 

# 因特网

什么是因特网？

可以从因特网的**组成**和**应用**两方面来看。

## 组成

因特网是由个人电脑，手机，汽车等一系列能够连接上网设备所组成，而这些设备统称为主机或端系统。所以因特网是由主机或端系统组成。

端系统与端系统之间通过 **通信链路** 和 **分组交换** 连接到一起。

通信链路就是我们日常所见到的电缆，存在很多种类型。例如铜线，光纤等。通信链路传输信息的快慢用**传输速率**来衡量，也就是 bit/s 或 bps ，表示每秒传输信息的多少。

当两个端系统之间进行通信时会将数据拆分成好多段，并且会在每一段里面加上一些信息，也就是首部字节。然后好多这样的信息放在一起变成了包。这个过程叫做**分组** 。 这些分组再通过网络发送到对应的端系统上，然后再组装到一起。

而分组交换机的作用就是用来转发分组，根据入通信链路接受到分组，再根据出通信两路将分组发出去，不断的将分组传送到目的地。

分组交换机分路由器和链路层交换机两种类型。前者处于网络的核心位置，而后者则是处于接入网中。

端系统通过因特网服务（ISP）提供上接入互联网中。而 ISP 本身就是多台分组交换机和多段通信链路组成的互联网。

ISP 提供多种方式接入互联网中，例如光纤，DSL，移动无线接入等。所以因特网就是将端系统连接起来。

而 ISP 本身也是需要连接到互联网上，连接了更高一层的 ISP 上。ISP 本身是独立管理运行着 IP 协议，遵守着命名和地址规则。

端系统，分组交换机和其他的组成部分都需要遵守一些列协议，这些协议控制着信息的发送与接收。其中 TCP/IP 则是两个非常重要的协议。IP 协议定义了路由器和端系统至今啊发送接受数据的分组格式，

协议的一致性非常重要，有专门的组织在制定统一的标准。因特网协议则是由因特网工程任务组（IETF）研发，IETF 的标准文档称为请求评论（RFC），RFC 详细的定义了很多协议，例如TCP，IP，HTTP等。

### 服务
从服务的角度来看待因特网，例如网站，网站存放在服务器上，也就是端系统之上。而这个网站可以在不同的主机上呗访问到，提供相应的服务。着就是分布式应用程序。手机中 APP 也是这样，例如微信，接受发送消息均需要经过微信的服务器。

与因特网相连的端系统提供了**套接字接口**，这些接口规定了不同端系统之间数据交付的方式。

## 协议
协议就是一系列的规定和针对相应事件的流程。

## 网络
之前提过连接在因特网上的所有设备都称为端系统或主机。而进一步可以将端系统划分为客户端和服务器端两种类型。

客户端通常指个人电脑，手机等设备。而服务器端则指存放资源的端系统。例如当访问网页时通过手机（客户端）看到的网页就是从服务器中发送过来的。

# 接入网
接入网指端系统物理连接到边缘路由器的网络，而边缘路由器就是端系统到其他任何远程终端路径上的第一台路由器。

接入方式总体上分为家庭接入，企业接入，广域无线接入三种。

### 家庭接入

* 家庭接入也就是将家里的电脑等终端设备连上网，也就是连上宽带。而连上宽带的方式比较流行的有数字用户线（DSL）和电缆两种类型。

数字用户线是借用了电话线来传送信息，通过电话线实现了上网的功能。电话线一般是双绞铜线，可以用不同的频率进行编码。分为三个级别：高速下行信道（50kHz - 1MHz），中速上行信道（4kHz - 50kHz），普通的双向电话信道（0 - 4kHz）

用户家里有一个 DSL 调制解调器，将得到的数字数据转换为高频音。然后通过电话线传送给本地中心局（co）。因为存在多个家庭，co 里面有一个复用器（DSLAM）用于交换数据，将许多家庭的模拟信号在 DSLAM 上转换为数字形式，然后将数据送到因特网上。

DSL 定制了不同的传输速率，这个速率和距离，价格都有一定的关系。一般而言距离 CO 不是 5 - 10 英里内的话需要用别的方式接入因特网。

* 电缆因特网接入，利用了有线电视来接入实现上网功能。

材质一般采用光纤和同轴电缆混合的方式，也称为混合光纤同轴系统（HFC）。其中 CO 到相应地区枢纽采用光纤连接，而地区到达各家各户采用同轴电缆连接。 

在电缆头端，同样存在和 DSLAM 相同的功能 CMTS 用来将所有家庭传送过来的模拟信号转换为数字形式。HFC 将网络划分为下行和上行两个信道，下行信道比上行信道速率高，分别是: 42.8Mbps 30.7Mbps ，理论上是这样，但是由于实际中传输损耗的存在会使得速率小于理论值。

电缆因特网最重要的特征是共享广播媒体，带来的问题也就是用的人越多越卡。用的人少时速度快。因为上行信道是共享的所以也存在碰撞。

* 光纤到户（FTTH）
光纤到户意味着从本地中心局到用户家中的链接全部采用光纤。根据连接的方式存在两种形式，一种是一家占用一条线，另一种是一条总线，快到用户家里了才分出一条支线。

根据以上的分配方式出现了两种光纤分布体系：有源光纤网络（AON）和无源光纤网络（PON），AON 的本质是交换以太网，这个以后再说。

PON 的流程是，线看本地电话中心是怎么连接上网的，本地电话中心通过光缆拿到了用户家中传过来的光信号，本地电话中心通过光纤线路端接收器（OLT）将光信号转化为电信号，然后经过本地电话中心的路由器连接上因特网。

再来看用户和本地电话中心之间的连接，用户家里面由路由器，路由器和光纤网络端接收器相连接（ONT），再由专门的光纤连接到邻近的分配器上。分配器实现了将多个家庭几种到一起根光纤上，家庭数目一般少于 100 个。

FTTH 有潜力提供每秒千兆比特范围的因特网接入速率。

### 企业接入

* 在公司或者大学校园中一般采用局域网（LAN）将端系统连接到边缘路由器上

局域网技术有很多，其中以太网是最流行的。速度方面用户可以达到 100Mbps 或 1Gbps，服务器则可以达到 1Gbps 或 10Gbps 的接入速率

除此之外还有无线接入，也就是 WIFI 。

虽然以太网和 WIFI 最初是企业接入的，但是现如今家庭一般都有 WIFI 不仅仅在企业接入中。

### 广域无线接入
* 广域无线接入就是 3G/4G/5G 也就是日常使用的流量。可以通过数万米外的基站实现入网。除此之外还有来源于 3G 技术的 LTE 。

## 物理媒体
物理媒体有多种类型，根据信号传播的介质可以分为导引型媒体和非导引型媒体。

导引型就是有线的，例如铜线，光缆或同轴电缆。非导引型是无线的，例如 WIFI，电磁波等这种在空气或者在外层空间（例如太空）中传播的信号。

1. 双绞铜线：日常生活中最常见的传导介质。电话线大都是由两根绝缘铜线组成，为防止电气干扰两根铜线螺旋缠绕。速度一般为 10Mbps - 10Gbps ，速度还取绝与线的粗细和传输方式以及接受方式。
2. 同轴电缆：两个导体同心的而非并行。可被作为导引型的共享媒体。
3. 光纤：以光脉冲的形式发送信号，一个脉冲表示一个比特。速率极高，难以窃听但是造价昂贵。
4. 陆地无线点信道：无线传播，不依赖物理线路可穿透墙壁。但是穿透物体时会使得信号的强度降低。根据距离可大致分为三类：短距离一到两米。局域传播十米到几百米，一般用于个人设备。广域传播数万米，一般用于无线 LAN，蜂窝接入技术。
5. 卫星无线电信道：卫星上面装有微波发射器和接收器，在一个频段上接受传输，然后再使用另一个转发器再生信号并在另一个频率上发射。存在同步卫星和近地轨道两种类型的卫星。


# 网络核心

互联网的核心由端系统的**分组交换机**和**链路构成的网状网络** 组成。

## 分组交换技术
端系统彼此之间通过报文来发送信息，而报文既可以执行一些控制功能也可以承载一些数据。

将长报文划分成较小的数据块称为分组，而分组则通过通信链路和分组交换机（路由器/链路层交换机）将信息从源主机发往目的主机。

1. 存储转发传输

路由器只有接受到完整的报文后才会将报文送出去，而途中接受到的部分报文会缓存下来，直到拿到完整的报文。

假设导线的传输速率为 R 比特每秒，信息为 L 比特 ，而传输这段信息所需要的时间就是 $L/R$ 

假设两个主 a/b 机之间存在一个路由器 t，主机 a 向主机 b 发送信息需要经过路由器 t 的转发。主机a 向路由器 t 发生数据所消耗的时延为 $L/R$ ，而当路由器完全接受这段信息后再向主机 b 发送这段信息所需要的时延为 $L/R$ 。所以总时延就是 $2L/R$

而如果主机 a 和主机 b 之间没有路由器 t 的话，传输这段信息所消耗的时延为 $L/R$

当有 N 条速率为 R 的链路组成的路径的时延为 $d=N\frac{L}{R}$

2. 排队时延

当分组到达路由器后，路由器有多条链路可以选择，选择一个合适的链路将这个当前分组送往目的地。而每一条链路都对应一个输出队列，也叫输出缓存。只有当前的数据报发出去后才从输出队列中取出发送下一个分组。如果输出队列满了的话，那么当前想要加入的分组就会被丢弃，也就是分组丢包。

3. 转发表和路由选择协议

路由器是如何为分组选择合适的链路的？当分组到达路由器后，路由器中存了一张**转发表**，根据分组里面的目的地址或者目的地址的一部分，路由器根据转发表将目的地址映射出一条输出链路。

而转发表这是根据**路由选择协议**配置出来的。路由选择协议决定了路由器到目的地的最短路，并使用最短路的结果来配置转发表。至于转发表和路由选择协议后续会详解。

## 电路交换
电路交换是提前建立了连接，将方面方面都打点好，建立起自己的传输通道，预留了所需要的资源，以恒定的速率传输信息。而分组交换则是车道山前必有路，走一步看一步，毕竟提供的是尽最大努力的交付，传不到我也没办法。

电路交换是建立一条真实的物理通道，随时可以通信，例如电话，但是如果电话连着不说话，也就是处于静默期的话，这些资源还是被占用的。所以这些资源是浪费了。而分组交换则可以充分利用所有资源。

1. 电路交换网络中的复用
复用指在一条信道上可以同时传输多个不同频率的信号，这些不同频率的信号形成了复合信号。

而在电路交换网络中存三种基本的多路复用方式：根据频率来分有**频分复用（FDM）**，根据时间区分信号有**时分复用（TDM）**，根据扩频码区分信号的方法称为**码分复用**。

频分复用：将传输信号分为多个频段，不同频段传输不同的信号，频段与频段之间互不交叠。这样使得传输过来的信息包含多种类型。然后在将不同频段内的加以处理信息区分开来。但是需要多个滤波器才能将信号区分开。

时分复用：将传输时间划分成多个登场的时间段（TMD帧），再将这些时间段划分成更小的时间段（时隙）。传输时在不同的时隙上进行切换，

2. 分组交换和电路交换的对比

分组交换不需要提前建立连接，而是尽最大努力的交付，所以当多用户同时使用时会出现拥塞。但是节省带宽资源。

而电路交换需要提前建立连接比较稳定，但是这个资源是始终被占用的，如果这个资源没有使用，也就是处于静默期，这些被占用的资源就属于浪费掉了。

##  网络的网络
网络的整体结构在不断的发展，发展过程中了五种结构，这后一种结构是在前一种结构的基础上进行优化迭代的。逐步的发现才形成了现在我们所使用的网络结构。

我们通过 ISP 连接上网，也就是互联网服务提供商。但是如果我们和想通信的人之间不是同一个 ISP 的话是无法连接的。所以不同的 ISP 之间也需要相互连接，但是全球存在数十万个 ISP，如果每一个 ISP 都和其他所有的 ISP 之间都有单独的通信链路的话显然不可能的而且浪费资源。

* 网络结构1：这种网络结构在 ISP 之上还存在一个 ISP ，也就是有一个全球的 ISP ，全球 ISP 链接了全世界数十万个接入的 ISP。而接入的 ISP 称为客户，全球传输的 ISP 称为供应商。除此之外维护全球 ISP 这个庞大的网络自然需要向客户 ISP收费。

* 网络结构2：只有一个全球 ISP 需要承担很大的流量，而且一家独大形成垄断显然不合理。于是公司可以建立全球 ISP ，全球 ISP 不再是一个了，出现了多个全球 ISP 。并且全球 ISP 之间是相互连接的，如果没有连接的话在不同的全球 ISP 下会出现无法通信的情况。而全球 ISP 之间存在竞争关系，更快的速度更优质的服务供客户选择，这种结果显然我们想要的。这种结构目前来看依旧是两层，全球 ISP 和接入 ISP，接入 ISP 处于底层，全球 ISP 处于顶层。

* 网络结构3：针对上一种结构，在接入 ISP 和全球 ISP 之间增加了区域 ISP ，全球 ISP 不再收费。

* 网络结构4：增加了 POP，多宿，对等和因特网交换点。

POP 存在与接入 ISP 之上，是将互联网从一个地方连接到其他地方的入网点。

除了第一层 ISP 的任何 ISP 都可以选择多宿，也就是可以选择多个提供上的 ISP 相连接，这样即使其中一个出现故障，还能够继续转发和接收分组。

对等：当 ISP 之间的层次结构相同时称他们是对等的，对等的 ISP 之间不需要相互付费。

因特网交换点：将对等的 ISP 交互起来放在一起，就是因特网交汇点也就是 IXP。

综上就是网络结构 4 新增加的东西。

* 网络结构5：增加了内容提供商。公司为了提供更好的服务并且更好的控制数据，于是建立起自己的专有网络，并且尝试绕过顶层的 ISP，在全球需要建立很多服务器。这些服务器就是内容提供商，内容提供商可以直接和接入 ISP ，IXP 区域 ISP 相连接。

总结：ISP 网络的不断进化，一层一层的递增逐步形成了如今我们所看到的样子。

# 分组交换中的时延，丢包和吞吐量
不同的端系统之间交换数据不出错是很难的，存在很多的问题。于是为了优化解决这些问题设计出了一些方法，引入了一些概念，例如时延，丢包，吞吐量。

## 时延
时延分为多种，其中重要的如下：总时延 = 节点处理时延 + 排队时延 + 传输时延 + 传播时延 。

数据到达路由器后首先根据目的地址处理选择合适的出路径（节点处理时延），并且还存在差错控制，也就是判断一下发过来的分组有没有错。

当之后将分组挂在在对应链路下的队列种等待分组传输，这个等待的过程称为排队时延。

当好不容易排到了自己，开始将路由器将分组传输到链路上，也就是这路由器开始发送分组到发送分组结束或者说开始接受分组到完全接受分组的这段时间，而这个过程消耗的时间称为传输时延。

此时分组已经进入链路，开始在向另一个路由器前进，这个过程称为传播时延。

综上：

* 处理时延：检查首部并选择将分组导向何处所消耗的时间。
* 排队时延：分组在链路上等待所消耗的时间。
* 传输时延：分组是一先到先服务的方式进行传输的。表示排到当前分组后传输所消耗的时间。也就是当前分组轮到传输到推出路由器所消耗的这段时间。所消耗的时间和分组长度和链路传输速率有关。
* 传播时延：分组从上一个路由器到下一个路由器之间所消耗的时间。所消耗的时间和距离有关。

注意区分传输时延和传播时延的区别。传输时延表示将整个分组的数据传输到链路上所消耗的时间，而传播时延则是指数据在两个路由器链路之间传播所消耗的时间。

## 排队时延和丢包
分组的排队时延差别比较大，可能有的分组来到路由器后直接就能够进行传输，而有的则前面有一大堆的分组等待着传输。于是采用平均等待速率来衡量分组时延。

平均等待速率用 a 表示，单位是 分组/秒 ，也就是 $\frac{pkt}{s}$ ，例如当前路由器中 5 个队列停留了 10 s 于是 $a=\frac{5}{10}$ 所以 a 可以直观的表示分组的处理速度。

如果假设每一个分组的大小都是 L 比特，那么 $L*a$ 就是以比特位单位的处理速度了。每秒处理多少比特的分组。

再进一步，轮到分组后需要对分组进行传输，也就是将分组传输到介质上的这个过程，此过程的传输速率是 R 比特/秒 ，而 $\frac{L*a}{R}$ 则表示流量强度。

仔细观察这个公式 $\frac{L*a}{R}$ 可以直观的看出，分子表示入，分母表示出。有一条规定是设计系统时流量强度不能大于一。例如一个水池，分子大于分母，也就是入大于出，那么水池迟早会被撑满。其中水表示队列，水池表示路由器，进来的水表示分组。

当 流量强度 $\frac{L*a}{R} > 1$ 时会使得队列产生然后边长，而 $\frac{L*a}{R} < 1$ 时则会使队列长度缩短。还是水池的例子，前者表示进来的水多余出去的水，然后水池中盛的水越来越多，反之水少甚至没有。

丢包指队列已满，没有多余的空间了，那么只能将这个包扔掉，重传了。也就是水池满了，水溢出来了，而溢出去的水就是丢弃的包。

## 端到端的时延
上面提到的都是单台路由器上的时延。假设有 $N-1$ 台路由器的话，而如下则是端到端之间的时延。

$d_{end-end} = N(d_{proc} + d_{trans} + d_{prop})$

加上了处理时延和传播时延。除此之外还有一些其他的时延，这些时延后续再详解。

## 吞吐量
吞吐量有瞬时吞吐量和平均吞吐量之分。在实际中，时延不是决定性的，但却希望有更高的吞吐量。

影响吞吐量有多个方面，重要为传输速率和干扰流量

从传输速率方面来看。假设两个端系统 a，b 之间有 N 条链路的网络，其中每条链路的传输速率分别为 $R_1,R_2,R_3,···,R_N$ 

那么这 N 条链路的吞吐量为 $min\{R_1,R_2,R_3,···,R_N\}$ 整条链路的吞吐量取决于传输速率最慢的那条链路。反之的话会导致挤压比特不断增加。当需要传输大小为 F 比特的文件时所需时间就是 $\frac{F}{min\{R_1,R_2,R_3,···,R_N\}}$ 

而干扰流量方面。如果其他许多的数据流通过这某条链路也会这条链路成为链路瓶颈。

# 协议层次及其服务类型
因特网的这个系统非常复杂，不易管理。面对这些问题，于是人们对体系结构进行了构建梳理。

## 分层体系结构

利用分层的思想，将体系分为多层。每一层只管理自己的部分，出现问题后也方便排错。修改内容时只需要保证接口不变结即可，也就是结构化的思想。

1. 协议分层
将计算机网络分层，分层后每一层只需要考虑向上一层提供相应的服务即可。

而每一层的所有协议称为协议栈，可以根据协议栈来区分。而协议栈来由五个层次组成，自顶向下分别如下。

* 应用层：应用层协议，网络（HTTP）/ 邮件传输（SMTP）/ 文件传输（FTP）/ 域名解析（DNS），不同端系统的应用层之间交换的信息分组称为报文。
* 运输层：用来运输报文，有两种协议 TCP/UDP 。 TCP 提供面向连接的服务，确保传递和流量控制并且将长报文划分为短报文，提供拥塞控制。UDP 提供的则是无连接服务，没有可靠性没有流量控制也没有拥塞控制。而运输层的分组称为报文段。
* 网络层：IP协议/路由选择协议，根据运输层提供的报文段和目的地址将起封装成数据报，然后将数据报发给另一台主机。数据报的格式是由 IP 协议制定的，而路由选择协议有很多种。
* 链路层：链路层里面的协议有很多，不同网络的链路层的协议是不同的。网络层根据链路层提供的数据报判断协议类型，向上一层交付，同时链路层也将网络层提供的数据传输到下一层。链路层的协议称为帧。
* 物理层：最接近硬件的一层，有很多关于实际传输媒体的协议。目的就是将帧传输到下一个节点。

1. OSI 模型
OSI 模型是另一种协议栈。最初国际标准化组织（OSI）提出的是 7 层的网络，也就是开发互联模型（OSI）。

OSI七层模型分别为：应用层，表示层，会话层，运输层，网络层，链路层，物理层。

在应用层和运输层之间添加了表示层和会话层。

表示层用来解释通信的应用程序之间交换数据的含义。

会话层用来确定数据交换的定界和同步功能，包含了建立检查点和恢复方案的方法。

## 封装
应用层报文发送给运输层后，运输层会在报文上加上附加信息，也就是运输层首部信息。这个首部作用体现待接受端的运输层上。

应用层发送过来的报文里面也有应用层报文段，应用层报文段和运输层附加进来的信息共同构成了运输层报文段。因此运输层封装了应用层的报文。

运输层附加的信息可能有差错检查功能，允许接收端的运输层向上交付报文信息。

运输层再将报文发送个网络层，网络层又在运输层报文段的基础上添加了源和目的地址等信息。也就是封装成了网络层数据报。

网路层数据报继续发送给数据链路层，同理数据链路层继续增加首部信息封装成数据链路层帧。

所以每一层的分组都分为首部字段和有效载荷字段。而有效载荷字段通常来自上一层的分组。

# 网络攻击
1. 将程序放入计算机中

* 恶意软件：进入个人设备后破坏设备，删除文件，安装间谍软件窃取隐私。
* 僵尸程序：发送垃圾邮件，分布式拒绝服务攻击（DoS）。

2. 攻击服务器和网络基础设施
DOS攻击指攻击网络，主机或其他基础设施部分，使得这些东西不能被合法用户使用。

* 弱点攻击：向端系统发送制作精细的报文，使得服务器停止运行或崩溃。
* 带宽洪泛：攻击者向目标主机发送大量的分组，分组使得接入链接发送拥塞从而使得合法的分组无法到达服务器。
* 连接洪泛：攻击者在目的主机中建立大量的半开或全开的 TCP 链接，目的主机因为这些伪造的链接而占用资源，使得没有资源无法为合法用户建立链接。
1. 嗅探分组：当使用无线网接入因特网时，可以采用嗅探设备获取当前设备的所有发出分组和接收分组。也就获取了设备的所有交互信息。例如手机 和 wifi 相连接，利用嗅探设备可以捕获到手机和 wifi 之间传递的所有信息。
2. 伪装：当伪装一些列分组发送到目的主机时，因特网依旧是尽最大努力的交付不会怀疑，将其发送到目的地。例如当都某个主机信任某个 IP 地址，我们可以伪装成信任的 IP 地址同主机发送信息。
