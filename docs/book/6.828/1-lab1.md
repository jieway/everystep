# Lab 1: Booting a PC

é˜…è¯»ï¼šhttps://pdos.csail.mit.edu/6.828/2018/labs/lab1/

è¿™ä¸ªå®éªŒç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œç¬¬ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯ä¸ºäº†ç†Ÿæ‚‰ä½¿ç”¨ x86 æ±‡ç¼–è¯­è¨€ã€QEMU x86 ä»¿çœŸå™¨ã€ä»¥åŠ PC çš„åŠ ç”µå¼•å¯¼è¿‡ç¨‹ã€‚ç¬¬äºŒéƒ¨åˆ†æŸ¥çœ‹æˆ‘ä»¬çš„ 6.828 å†…æ ¸çš„å¼•å¯¼åŠ è½½å™¨ï¼Œå®ƒä½äº lab çš„ boot ç›®å½•ä¸­ã€‚ç¬¬ä¸‰éƒ¨åˆ†æ·±å…¥åˆ°åä¸º JOS çš„ 6.828 å†…æ ¸æ¨¡å‹å†…éƒ¨ï¼Œå®ƒåœ¨ kernel ç›®å½•ä¸­ã€‚

## 1. ç¯å¢ƒé…ç½®

    % mkdir ~/6.828
    % cd ~/6.828
    % git clone https://pdos.csail.mit.edu/6.828/2018/jos.git lab
    Cloning into lab...
    % cd lab
    % 

æ¥ä¸‹æ¥é˜…è¯» [tools](https://pdos.csail.mit.edu/6.828/2018/tools.html) è¿›è¡Œç¯å¢ƒé…ç½®ã€‚


ç¯å¢ƒï¼šWSL2 ubuntu20.04

    sudo apt-get install -y build-essential gdb
    sudo apt-get install gcc-multilib

    git clone https://github.com/mit-pdos/6.828-qemu.git qemu
    sudo apt-get install libsdl1.2-dev libtool-bin libglib2.0-dev libz-dev libpixman-1-dev
    ./configure --disable-kvm --disable-werror --target-list="i386-softmmu x86_64-softmmu"

å‡ºé”™ï¼š

    /usr/bin/ld: qga/commands-posix.o: in function `dev_major_minor':
    /home/yunwei/qemu/qga/commands-posix.c:633: undefined reference to `major'
    /usr/bin/ld: /home/yunwei/qemu/qga/commands-posix.c:634: undefined reference to `minor'
    collect2: error: ld returned 1 exit status

åœ¨ `qga/commands-posix.c` æ–‡ä»¶ä¸­åŠ ä¸Šå¤´æ–‡ä»¶: `#include<sys/sysmacros.h>`

    make && make install

è¿›å…¥ lab æŠ¥é”™ï¼š

    $ make
    + ld obj/kern/kernel
    ld: warning: section `.bss' type changed to PROGBITS
    ld: obj/kern/printfmt.o: in function `printnum':
    lib/printfmt.c:41: undefined reference to `__udivdi3'
    ld: lib/printfmt.c:49: undefined reference to `__umoddi3'
    make: *** [kern/Makefrag:71: obj/kern/kernel] Error 1

è§£å†³æ–¹æ¡ˆæ˜¯å®‰è£… 4.8 çš„ gcc ï¼Œä½†æ˜¯æŠ¥é”™ï¼ŒåŸå› æ˜¯è¿™ä¸ªåŒ…æ²¡æœ‰åœ¨è¿™ä¸ªæºä¸­ã€‚

    $ sudo apt-get install -y gcc-4.8-multilib
    Reading package lists... Done
    Building dependency tree       
    Reading state information... Done
    E: Unable to locate package gcc-4.8-multilib
    E: Couldn't find any package by glob 'gcc-4.8-multilib'
    E: Couldn't find any package by regex 'gcc-4.8-multilib'

ç»è¿‡ä¸€ç•ªæŠ˜è…¾ï¼Œçœ‹åˆ°äº†è¿™ç¯‡[æ–‡ç« ](https://blog.csdn.net/feinifi/article/details/121793945)ã€‚ç®€å•æ¥è¯´å°±æ˜¯è¿™ä¸ªåŒ…åœ¨ Ubuntu16.04 ä¸‹å¯ä»¥æ­£å¸¸ä¸‹è½½ï¼Œé‚£ä¹ˆå¢åŠ è¿™ä¸ªåŠçš„æºå³å¯ã€‚åœ¨ `/etc/apt/sources.list` ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

    deb http://dk.archive.ubuntu.com/ubuntu/ xenial main
    deb http://dk.archive.ubuntu.com/ubuntu/ xenial universe

åˆ‡è®°ï¼Œéœ€è¦æ›´æ–°

    sudo apt-get update

ç„¶åå†æ¬¡å¯åŠ¨ qemu ä¾æ—§æŠ¥é”™ï¼ˆæ­¤æ—¶å·²ç»è¿‡å»ä¸€å¤©äº†ğŸ¥²ï¼‰

    $ make
    + ld obj/kern/kernel
    ld: warning: section `.bss' type changed to PROGBITS
    ld: obj/kern/printfmt.o: in function `printnum':
    lib/printfmt.c:41: undefined reference to `__udivdi3'
    ld: lib/printfmt.c:49: undefined reference to `__umoddi3'
    make: *** [kern/Makefrag:71: obj/kern/kernel] Error 1

ç»è¿‡åˆ†æï¼Œå‘ç° gcc ç‰ˆæœ¬æ²¡æœ‰ä¿®æ”¹

    $ gcc --version
    gcc (Ubuntu 8.4.0-3ubuntu2) 8.4.0
    Copyright (C) 2018 Free Software Foundation, Inc.
    This is free software; see the source for copying conditions.  There is NO
    warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

äºæ˜¯å°† gcc ç‰ˆæœ¬æ”¹ä¸º 4.8 ã€‚åˆ é™¤åŸæ¥çš„è½¯è¿æ¥ï¼Œå¢åŠ æŒ‡å‘ 4.8 ç‰ˆæœ¬çš„ è½¯è¿æ¥ã€‚æŸ¥çœ‹ç‰ˆæœ¬æ›´æ–°æˆåŠŸã€‚

    $ sudo rm /usr/bin/gcc
    $ sudo ln -s /usr/bin/gcc-4.8 /usr/bin/gcc
    $ gcc --version
    gcc (Ubuntu 4.8.5-4ubuntu2) 4.8.5
    Copyright (C) 2015 Free Software Foundation, Inc.
    This is free software; see the source for copying conditions.  There is NO
    warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

å†æ¬¡ç¼–è¯‘ï¼Œæ²¡æœ‰é—®é¢˜äº†ï¼

    $ make
    + ld obj/kern/kernel
    ld: warning: section `.bss' type changed to PROGBITS
    + as boot/boot.S
    + cc -Os boot/main.c
    + ld boot/boot
    boot block is 380 bytes (max 510)
    + mk obj/kern/kernel.img

    $ sudo make qemu

è‡³æ­¤ï¼Œç¯å¢ƒé…ç½®å®Œæˆï¼š

![20220417223135](https://cdn.jsdelivr.net/gh/weijiew/pic/images/20220417223135.png)

æ¥ä¸‹æ¥ç»§ç»­é˜…è¯» lab1 ï¼šhttps://pdos.csail.mit.edu/6.828/2018/labs/lab1/ 

ä½¿ç”¨ `make grade` æ¥æµ‹è¯•ï¼ŒéªŒè¯ç¨‹åºæ˜¯å¦æ­£ç¡®ã€‚

## Part 1: PC Bootstrap

ä»‹ç» x86 æ±‡ç¼–è¯­è¨€å’Œ PC å¼•å¯¼è¿‡ç¨‹ï¼Œç†Ÿæ‚‰ QEMU å’Œ QEMU/GDB è°ƒè¯•ã€‚ä¸ç”¨å†™ä»£ç ä½†æ˜¯éœ€è¦å›ç­”é—®é¢˜ã€‚

### Exercise 1.

ç†Ÿæ‚‰æ±‡ç¼–è¯­è¨€ã€‚

### The PC's Physical Address Space

`make qemu` å’Œ `make qemu-nox` éƒ½æ˜¯ç”¨æ¥å¯åŠ¨ qemu ï¼ŒåŒºåˆ«æ˜¯åè€…ä¸å¸¦å›¾å½¢ç•Œé¢ã€‚

    +------------------+  <- 0xFFFFFFFF (4GB)
    |      32-bit      |
    |  memory mapped   |
    |     devices      |
    |                  |
    /\/\/\/\/\/\/\/\/\/\

    /\/\/\/\/\/\/\/\/\/\
    |                  |
    |      Unused      |
    |                  |
    +------------------+  <- depends on amount of RAM
    |                  |
    |                  |
    | Extended Memory  |
    |                  |
    |                  |
    +------------------+  <- 0x00100000 (1MB)
    |     BIOS ROM     |    BIOS åŸºæœ¬çš„è¾“å…¥è¾“å‡º
    +------------------+  <- 0x000F0000 (960KB)
    |  16-bit devices, |
    |  expansion ROMs  |    
    +------------------+  <- 0x000C0000 (768KB)
    |   VGA Display    |    ç”¨äºè§†é¢‘æ˜¾ç¤º
    +------------------+  <- 0x000A0000 (640KB)
    |                  |
    |    Low Memory    |  æ—©æœŸ PC å”¯ä¸€å¯ä»¥è®¿é—®çš„åŒºåŸŸ
    |                  |  å®é™…ä¸Šæ—©æœŸ PC ä¸€èˆ¬å†…å­˜å¤§å°ä¸º 16KB, 32KB, æˆ– 64KB
    +------------------+  <- 0x00000000


æ—©æœŸçš„ PC æ˜¯ 16bit ï¼Œä¾‹å¦‚ 8088 å¤„ç†å™¨ï¼Œåªèƒ½å¤„ç† 1MB çš„ç‰©ç†å†…å­˜ã€‚æ‰€ä»¥ç‰©ç†ç©ºé—´ä» 0x00000000 å¼€å§‹åˆ° 0x000FFFFF ç»“æŸï¼Œå¹¶éæ˜¯ 0xFFFFFFFF ç»“æŸã€‚

1. å…¶ä¸­å‰ 640KB æ˜¯ä½å†…å­˜ï¼Œè¿™æ˜¯æ—©æœŸ PC å”¯ä¸€å¯ä»¥éšæœºè®¿é—®çš„åŒºåŸŸï¼Œæ­¤å¤–æ—©æœŸ PC çš„å†…å­˜å¯ä»¥è®¾ç½®ä¸º 16KBï¼Œ32KB æˆ– 64KB ã€‚

2. ä» 0x000A0000 åˆ° 0x000FFFFF è¿™ç‰‡å†…å­˜åŒºåŸŸç•™ç»™ç¡¬ä»¶ä½¿ç”¨ï¼Œä¾‹å¦‚è§†é¢‘æ˜¾ç¤ºçš„ç¼“å†²åŒºï¼ŒBasic Input/Output System (BIOS) ã€‚èµ·åˆè¿™ç¯‡åŒºåŸŸæ˜¯ç”¨ ROM æ¥å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯åªèƒ½è¯»ä¸èƒ½å†™ï¼Œç›®å‰æ˜¯ç”¨ flash æ¥å®ç°ï¼Œè¯»å†™å‡å¯ã€‚æ­¤å¤– BIOS è´Ÿè´£åˆå§‹åŒ–ï¼Œå®Œæˆåä¼šå°† OS åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åå°†æ§åˆ¶æƒäº¤ç»™ OS ã€‚

éšç€æ—¶ä»£çš„å‘å±•ï¼ŒPC å¼€å§‹æ”¯æŒ 4GB å†…å­˜ï¼Œæ‰€ä»¥åœ°å€ç©ºé—´æ‰©å±•åˆ°äº† 0xFFFFFFFF ã€‚ä½†æ˜¯ä¸ºäº†å…¼å®¹å·²æœ‰çš„è½¯ä»¶ï¼Œä¿ç•™äº† 0 - 1MB ä¹‹é—´çš„å†…å­˜å¸ƒå±€ã€‚0x000A0000 åˆ° 0x00100000 è¿™åŒºåŸŸçœ‹èµ·æ¥åƒæ˜¯ä¸€ä¸ªæ´ï¼Œå‰ 640kb æ˜¯ä¼ ç»Ÿå†…å­˜ï¼Œå‰©ä½™çš„éƒ¨åˆ†æ˜¯æ‰©å±•å†…å­˜ã€‚æ­¤å¤–åœ¨ 32 ä½ä¸‹ï¼ŒPC é¡¶ç«¯çš„ä¸€äº›ç©ºé—´ä¿ç•™ç»™ BIOS ï¼Œæ–¹ä¾¿ 32 ä½ PCI è®¾å¤‡ä½¿ç”¨ã€‚ä½†æ˜¯æ”¯æŒçš„å†…å­˜ç©ºé—´å·²ç»è¶…è¿‡äº† 4GB çš„ç‰©ç†å†…å­˜ï¼Œä¹Ÿå°±æ˜¯ç‰©ç†å†…å­˜å¯ä»¥æ‰©å±•åˆ° 0xFFFFFFFF ä¹‹ä¸Šã€‚ä½†æ˜¯ä¾æ—§ä¸ºäº†å…¼å®¹ 32 ä½è®¾å¤‡çš„æ˜ å°„ï¼Œåœ¨ 32 ä½é«˜åœ°å€éƒ¨åˆ†ç•™ç»™ BIOS çš„è¿™ç‰‡å†…å­˜åŒºåŸŸä¾æ—§ä¿ç•™ï¼Œçœ‹èµ·æ¥åƒç¬¬äºŒä¸ªæ´ã€‚æœ¬å®éªŒä¸­ï¼Œ JOS åªä½¿ç”¨äº†å‰ 256MBï¼Œå¯ä»¥å‡è®¾åªæœ‰ 32 ä½çš„ç‰©ç†å†…å­˜ã€‚

* ä¸ºä»€ä¹ˆ 16 ä½ PC çš„å¯»å€ç©ºé—´æ˜¯ 1MB ï¼Ÿ

ä»¥ 8086 CPU ä¸ºä¾‹ï¼Œæ•°æ®çº¿æ˜¯ 16 ä½($2^{16} = 64KB$)çš„ï¼Œè€Œåœ°å€çº¿æ˜¯ 20 ä½( $2^{20} = 1MB$)ã€‚æ•°æ®çº¿å†³å®šäº†ä¸€æ¬¡èƒ½è·å–çš„æ•°æ®é‡ï¼Œæ‰€ä»¥ä¸€æ¬¡åªèƒ½å– 64KBï¼Œåœ°å€çº¿å†³å®šäº†å¯å¯»å€ç©ºé—´å¤§å°ï¼Œæ‰€ä»¥å¯»å€ç©ºé—´æ˜¯ 1MB ã€‚è¿™ä¹Ÿè§£é‡Šäº†å®æ¨¡å¼ä¸‹ä¸ºä»€ä¹ˆæ®µé•¿æ˜¯ 64KB ã€‚

* æ–°çš„é—®é¢˜äº§ç”Ÿäº†ï¼Œå¯„å­˜å™¨éƒ½æ˜¯ 16 ä½çš„ï¼Œæ€ä¹ˆè¡¨ç¤º 20 ä½çš„åœ°å€ï¼Ÿ

æ—¢ç„¶ä¸€ä¸ªå¯„å­˜å™¨æ— æ³•è¡¨ç¤ºé‚£ä¹ˆå°±ç”¨ä¸¤ä¸ªå¯„å­˜å™¨æ¥è¡¨ç¤ºï¼Œä¹Ÿå°±æ˜¯åˆ†æ®µã€‚å°† 1MB çš„ç©ºé—´åœ¨é€»è¾‘ä¸Šä»¥ 64KB ä¸ºå•ä½åˆ‡åˆ†ï¼Œæ®µé•¿å°±æ˜¯ 64KB ã€‚åœ°å€ç”±æ®µåŸºåœ°å€å’Œæ®µå†…åç§»ä¸¤éƒ¨åˆ†ç»„æˆï¼Œå…¶ä¸­æ®µåŸºå€å·¦ç§»å››ä½ï¼ŒåŠ ä¸Šæ®µå†…åç§»ã€‚

### The ROM BIOS

è¿™ä¸€éƒ¨åˆ†å°†ä¼šä½¿ç”¨ qemu çš„ debug å·¥å…·æ¥ç ”ç©¶è®¡ç®—æœºå¯åŠ¨ã€‚

![20220504195748](https://cdn.jsdelivr.net/gh/weijiew/pic/images/20220504195748.png)

å¯ä»¥ç”¨ tmux å¼€ä¸¤ä¸ªçª—å£ï¼Œä¸€ä¸ªçª—å£è¾“å…¥ `make qemu-nox-gdb` å¦ä¸€ä¸ªçª—å£è¾“å…¥ `make gdb` æ‘˜å–å…¶ä¸­ä¸€è¡Œè¾“å…¥ä¿¡æ¯ï¼š

    [f000:fff0] 0xffff0:	ljmp   $0xf000,$0xe05b

PC ä» 0x000ffff0 å¼€å§‹æ‰§è¡Œï¼Œç¬¬ä¸€æ¡è¦æ‰§è¡Œçš„æŒ‡ä»¤æ˜¯ jmpï¼Œè·³è½¬åˆ°åˆ†æ®µåœ°å€ CS=0xf000 å’Œ IP=0xe05b ã€‚

èµ·åˆå› ç‰¹å°”æ˜¯è¿™æ ·è®¾è®¡çš„ï¼Œè€Œ BIOS å¤„äº 0x000f0000 å’Œ 0x000fffff ä¹‹é—´ã€‚è¿™æ ·è®¾è®¡ç¡®ä¿äº† PC å¯åŠ¨æˆ–é‡å¯éƒ½èƒ½è·å¾—æœºå™¨çš„æ§åˆ¶æƒã€‚

QEMU è‡ªå¸¦ BIOS å¹¶ä¸”ä¼šå°†å…¶æ”¾ç½®åœ¨æ¨¡æ‹Ÿçš„ç‰©ç†åœ°å€ç©ºé—´çš„ä½ç½®ä¸Šï¼Œå½“å¤„ç†å™¨å¤ä½æ—¶ï¼Œæ¨¡æ‹Ÿçš„å¤„ç†å™¨è¿›å…¥å®æ¨¡å¼ï¼Œå°† CS è®¾ç½®ä¸º 0xf000ï¼ŒIP è®¾ç½®ä¸º 0xfff0 ã€‚ç„¶åå°±åœ¨ CS:IP æ®µå¤„å¼€å§‹æ‰§è¡Œã€‚

åˆ†æ®µåœ°å€ 0xf000:ffff0 å¦‚ä½•å˜æˆç‰©ç†åœ°å€ï¼Ÿè¿™é‡Œé¢æœ‰ä¸€ä¸ªå…¬å¼ï¼š

    address = 16 * segment + offset

ä¾‹å¦‚ï¼š

    16 * 0xf000 + 0xfff0   # in hex multiplication by 16 is
    = 0xf0000 + 0xfff0     # easy--just append a 0.
    = 0xffff0 

0xffff0 æ˜¯ BIOS ç»“æŸå‰çš„16ä¸ªå­—èŠ‚ï¼ˆ0x100000ï¼‰ã€‚å¦‚æœç»§ç»­å‘åæ‰§è¡Œï¼Œ 16 å­—èŠ‚ BIOS å°±ç»“æŸäº†ï¼Œè¿™ä¹ˆå°çš„ç©ºé—´èƒ½å¹²ä»€ä¹ˆï¼Ÿ

### Exercise 2.

ä½¿ç”¨ gdb çš„ si æŒ‡ä»¤ææ¸…æ¥š BIOS çš„å¤§è‡´æƒ…å†µï¼Œä¸éœ€è¦ææ¸…æ¥šæ‰€æœ‰ç»†èŠ‚ã€‚

ä½¿ç”¨ si é€è¡ŒæŸ¥çœ‹æŒ‡ä»¤ï¼š

    [f000:fff0]    0xffff0: ljmp   $0xf000,$0xe05b  # è·³è½¬åˆ° `$0xfe05b` å¤„
    [f000:e05b]    0xfe05b: cmpl   $0x0,%cs:0x6ac8  # è‹¥ 0x6ac8 å¤„çš„å€¼ä¸ºé›¶åˆ™è·³è½¬
    [f000:e062]    0xfe062: jne    0xfd2e1
    [f000:e066]    0xfe066: xor    %dx,%dx          # å°† dx å¯„å­˜å™¨æ¸…é›¶
    [f000:e068]    0xfe068: mov    %dx,%ss          # å°† ss å¯„å­˜å™¨æ¸…é›¶
    [f000:e06a]    0xfe06a: mov    $0x7000,%esp     # esp = 0x7000 esp å§‹ç»ˆæŒ‡å‘æ ˆé¡¶
    [f000:e070]    0xfe070: mov    $0xf34c2,%edx    # edx = 0xf34c2 
    [f000:e076]    0xfe076: jmp    0xfd15c          # è·³è½¬åˆ° 0xfd15c
    [f000:d15c]    0xfd15c: mov    %eax,%ecx        # ecx = eax
    [f000:d15f]    0xfd15f: cli                     # å…³é—­ç¡¬ä»¶ä¸­æ–­
    [f000:d160]    0xfd160: cld                     # è®¾ç½®äº†æ–¹å‘æ ‡å¿—ï¼Œè¡¨ç¤ºåç»­æ“ä½œçš„å†…å­˜å˜åŒ–
    [f000:d161]    0xfd161: mov    $0x8f,%eax       # eax = 0x8f  æ¥ä¸‹æ¥çš„ä¸‰æ¡æŒ‡ä»¤ç”¨äºå…³é—­ä¸å¯å±è”½ä¸­æ–­
    [f000:d167]    0xfd167: out    %al,$0x70        # 0x70 å’Œ 0x71 æ˜¯ç”¨äºæ“ä½œ CMOS çš„ç«¯å£
    [f000:d169]    0xfd169: in     $0x71,%al        # ä»CMOSè¯»å–é€‰æ‹©çš„å¯„å­˜å™¨
    [f000:d16b]    0xfd16b: in     $0x92,%al        # è¯»å–ç³»ç»Ÿæ§åˆ¶ç«¯å£A
    [f000:d16d]    0xfd16d: or     $0x2,%al         
    [f000:d16f]    0xfd16f: out    %al,$0x92        # å¯åŠ¨ A20
    [f000:d171]    0xfd171: lidtw  %cs:0x6ab8       # åŠ è½½åˆ° IDT è¡¨
    [f000:d177]    0xfd177: lgdtw  %cs:0x6a74       # åŠ è½½åˆ° GDT è¡¨
    [f000:d17d]    0xfd17d: mov    %cr0,%eax        # eax = cr0
    [f000:d180]    0xfd180: or     $0x1,%eax        # 
    [f000:d184]    0xfd184: mov    %eax,%cr0        # æ‰“å¼€ä¿æŠ¤æ¨¡å¼
    [f000:d187]    0xfd187: ljmpl  $0x8,$0xfd18f    # é€šè¿‡ ljmp è¿›å…¥ä¿æŠ¤æ¨¡å¼
    => 0xfd18f:     mov    $0x10,%eax               # è®¾ç½®æ®µå¯„å­˜å™¨
    => 0xfd194:     mov    %eax,%ds
    => 0xfd196:     mov    %eax,%es

å½“ BIOS å¯åŠ¨çš„æ—¶å€™ä¼šå…ˆè®¾ç½®ä¸­æ–­æè¿°è¡¨ï¼Œç„¶ååˆå§‹åŒ–å„ç§ç¡¬ä»¶ï¼Œä¾‹å¦‚ VGA ã€‚

å½“åˆå§‹åŒ– PCI æ€»çº¿å’Œ BIOS çŸ¥æ™“çš„æ‰€æœ‰é‡è¦è®¾å¤‡åï¼Œå°†ä¼šå¯»æ‰¾ä¸€ä¸ªå¯å¯åŠ¨çš„è®¾å¤‡ï¼Œå¦‚è½¯ç›˜ã€ç¡¬ç›˜æˆ–CD-ROMã€‚

æœ€ç»ˆï¼Œå½“æ‰¾åˆ°ä¸€ä¸ªå¯å¯åŠ¨çš„ç£ç›˜æ—¶ï¼ŒBIOS ä»ç£ç›˜ä¸Šè¯»å– boot loader å¹¶å°†æ§åˆ¶æƒè½¬ç§»ç»™å®ƒã€‚

## Part 2: The Boot Loader

ç£ç›˜æ˜¯ç”±æ‰‡åŒºç»„æˆï¼Œä¸€ä¸ªæ‰‡åŒºä¸º 512 Bã€‚ç£ç›˜çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºç§°ä¸º boot sector ï¼Œè¿™é‡Œé¢å­˜æ”¾ç€ boot loader ã€‚

BIOS å°† 512B çš„ boot sector ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ 0x7c00 åˆ° 0x7dff ä¹‹é—´ã€‚ç„¶åä½¿ç”¨ jmp æŒ‡ä»¤è®¾ç½® CS:IP ä¸º 0000:7c00 æœ€åå°†æ§åˆ¶æƒä¼ é€’ç»™å¼•å¯¼è£…è½½ç¨‹åºã€‚åœ¨ 6.828 ä¸­ä½¿ç”¨ä¼ ç»Ÿçš„ç¡¬ç›˜å¯åŠ¨æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ boot loader ä¸èƒ½è¶…è¿‡ 512B ã€‚

boot loader ç”±æ±‡ç¼–è¯­è¨€ `boot/boot.S` å’Œä¸€ä¸ª C è¯­è¨€æ–‡ä»¶ `boot/main.c` ç»„æˆã€‚éœ€è¦ææ˜ç™½è¿™ä¸¤ä¸ªæ–‡ä»¶çš„å†…å®¹ã€‚

Boot Loader è´Ÿè´£ä¸¤ä¸ªåŠŸèƒ½ï¼š

1. boot loader ä»å®æ¨¡å¼åˆ‡æ¢åˆ° 32 ä½çš„ä¿æŠ¤æ¨¡å¼ï¼Œå› ä¸ºåªæœ‰åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹è½¯ä»¶æ‰èƒ½è®¿é—®è¶…è¿‡ 1MB çš„ç‰©ç†å†…å­˜ã€‚æ­¤å¤–åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œæ®µåç§»é‡å°±å˜ä¸ºäº† 32 è€Œé 16 ã€‚

2. å…¶æ¬¡ï¼ŒBoot Loader é€šè¿‡ x86 çš„ç‰¹æ®Š I/O æŒ‡ä»¤ç›´æ¥è®¿é—® IDE ç£ç›˜è®¾å¤‡å¯„å­˜å™¨ï¼Œä»ç¡¬ç›˜ä¸Šè¯»å–å†…æ ¸ã€‚

ç†è§£äº† Boot Loader çš„æºä»£ç åï¼Œçœ‹çœ‹ `obj/boot/boot.asm` æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶æ˜¯ GNUmakefile åœ¨ç¼–è¯‘ Boot Loader ååˆ›å»ºçš„ Boot Loader çš„åæ±‡ç¼–ã€‚è¿™ä¸ªåæ±‡ç¼–æ–‡ä»¶ä½¿æˆ‘ä»¬å¾ˆå®¹æ˜“çœ‹åˆ° Boot Loader çš„æ‰€æœ‰ä»£ç åœ¨ç‰©ç†å†…å­˜ä¸­çš„ä½ç½®ï¼Œä¹Ÿä½¿æˆ‘ä»¬æ›´å®¹æ˜“åœ¨ GDB ä¸­è·Ÿè¸ª Boot Loader å‘ç”Ÿäº†ä»€ä¹ˆã€‚åŒæ ·çš„ï¼Œ`obj/kern/kernel.asm` åŒ…å«äº† JOS å†…æ ¸çš„åæ±‡ç¼–ï¼Œè¿™å¯¹è°ƒè¯•å¾ˆæœ‰ç”¨ã€‚

åœ¨ gdb ä¸­ä½¿ç”¨ b *0x7c00 åœ¨è¯¥åœ°å€å¤„è®¾ç½®æ–­ç‚¹ï¼Œç„¶åä½¿ç”¨ c æˆ– si ç»§ç»­æ‰§è¡Œã€‚c å°†ä¼šè·³è½¬åˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹å¤„ï¼Œè€Œ si è·³è½¬åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œsi N åˆ™ä¸€æ¬¡è·³è½¬ N æ¡æŒ‡ä»¤ã€‚

ä½¿ç”¨ `x/Ni ADDR` æ¥æ‰“å°åœ°å€ä¸­å­˜å‚¨çš„å†…å®¹ã€‚å…¶ä¸­ N æ˜¯è¦åæ±‡ç¼–çš„è¿ç»­æŒ‡ä»¤çš„æ•°é‡ï¼ŒADDR æ˜¯å¼€å§‹åæ±‡ç¼–çš„å†…å­˜åœ°å€ã€‚

### Exercise 3. 

é˜…è¯» [lab tools guide](https://pdos.csail.mit.edu/6.828/2018/labguide.html)ï¼Œå³ä½¿ä½ å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œæœ€å¥½çœ‹çœ‹ã€‚

åœ¨ 0x7c00 è®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œå¯åŠ¨æ‰‡åŒºå°†ä¼šåŠ è½½åˆ°æ­¤å¤„ã€‚è·Ÿè¸ª `boot/boot.S` å¹¶ä½¿ç”¨ `obj/boot/boot.asm` æ¥å®šä½å½“å‰æ‰§è¡Œä½ç½®ã€‚ä½¿ç”¨ GDB çš„ x/i å‘½ä»¤æ¥åæ±‡ç¼– Boot Loader ä¸­çš„æŒ‡ä»¤åºåˆ—å¹¶å’Œ `obj/boot/boot.asm` æ¯”è¾ƒã€‚

* é˜…è¯» `obj/boot/boot.asm` ä¸‹é¢æ˜¯ä¸€äº›æ€»ç»“ï¼š

åœ¨æ±‡ç¼–ä¸­ . å¼€å¤´çš„æ˜¯æ±‡ç¼–å™¨æŒ‡ä»¤ï¼ŒåŠŸèƒ½æ˜¯å‘Šè¯‰æ±‡ç¼–å™¨å¦‚ä½•åšï¼Œè€Œä¸æ˜¯åšä»€ä¹ˆã€‚æ±‡ç¼–å™¨æŒ‡ä»¤å¹¶ä¸ä¼šç›´æ¥ç¿»è¯‘ä¸ºæœºå™¨ç ï¼Œæ±‡ç¼–æŒ‡ä»¤ä¼šç›´æ¥ç¿»è¯‘ä¸ºæœºå™¨ç ã€‚é¦–å…ˆè®¾ç½®å®æ¨¡å¼çš„æ ‡å¿—ï¼Œè¿›å…¥å®æ¨¡å¼ã€‚ç„¶åå…³é—­ä¸­æ–­ï¼Œé˜²æ­¢æ‰§è¡Œæ—¶è¢«æ‰“æ–­ï¼Œæ¥ä¸‹æ¥è®¾ç½®å­—ç¬¦ä¸²æŒ‡é’ˆçš„ç§»åŠ¨æ–¹å‘ã€‚åšäº†ä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œä¾‹å¦‚å¯„å­˜å™¨æ¸…é›¶ï¼Œå¼€å¯ A20 æ•°æ®çº¿ï¼Œä¸ºåˆ‡æ¢åˆ° 32 ä½åšå‡†å¤‡ã€‚å¤„ç† GDT ã€‚

è·Ÿè¸ª boot/main.c ä¸­çš„ bootmain() å‡½æ•°ï¼Œæ­¤åè¿½è¸ªåˆ° readsect() å¹¶ç ”ç©¶å¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œç„¶åè¿”å›åˆ° bootmain() ã€‚ç¡®å®šä»ç£ç›˜ä¸Šè¯»å–å†…æ ¸å‰©ä½™æ‰‡åŒºçš„forå¾ªç¯çš„å¼€å§‹å’Œç»“æŸã€‚æ‰¾å‡ºå¾ªç¯ç»“æŸåå°†è¿è¡Œçš„ä»£ç ï¼Œåœ¨é‚£é‡Œè®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œå¹¶ç»§ç»­åˆ°è¯¥æ–­ç‚¹ã€‚ç„¶åé€æ­¥å®Œæˆ Boot Loader çš„å‰©ä½™éƒ¨åˆ†ã€‚

* å›ç­”ä¸‹é¢çš„é—®é¢˜ï¼š

1. åœ¨ä»€ä¹ˆæ—¶å€™ï¼Œå¤„ç†å™¨å¼€å§‹æ‰§è¡Œ32ä½ä»£ç ï¼Ÿç©¶ç«Ÿæ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´ä»16ä½åˆ°32ä½æ¨¡å¼çš„è½¬æ¢ï¼Ÿ

* ä» boot.S çš„ç¬¬ 55 è¡Œå¼€å§‹åˆ‡æ¢ä¸º 32 ä½ä»£ç ï¼Œåˆ‡æ¢åˆ° 32 ä½åä¼šæœ‰æ›´å¤šçš„å¯»å€ç©ºé—´ã€‚

2. Boot Loader æ‰§è¡Œçš„æœ€åä¸€æ¡æŒ‡ä»¤æ˜¯ä»€ä¹ˆï¼Œå®ƒåˆšåˆšåŠ è½½çš„å†…æ ¸çš„ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯ä»€ä¹ˆï¼Ÿ

* æœ€åä¸€æ¡æŒ‡ä»¤æ˜¯ `boot/main.c` çš„ `((void (*)(void)) (ELFHDR->e_entry))();` 
*  `movw $0x1234, 0x472`

3. å†…æ ¸çš„ç¬¬ä¸€æ¡æŒ‡ä»¤åœ¨å“ªé‡Œï¼Ÿ

* å†…æ ¸çš„ç¬¬ä¸€æ¡æŒ‡ä»¤åœ¨ 0x1000c å¤„ï¼Œå¯¹åº”çš„æºç ä½äº kern/entry.S ä¸­ã€‚

4. Boot Loaderå¦‚ä½•å†³å®šå®ƒå¿…é¡»è¯»å–å¤šå°‘ä¸ªæ‰‡åŒºæ‰èƒ½ä»ç£ç›˜ä¸Šè·å–æ•´ä¸ªå†…æ ¸ï¼Ÿå®ƒåœ¨å“ªé‡Œæ‰¾åˆ°è¿™äº›ä¿¡æ¯ï¼Ÿ

> è¿™äº›ä¿¡æ¯å­˜æ”¾åœ¨ Proghdr ä¸­ã€‚

æ¥ä¸‹æ¥è¿›ä¸€æ­¥ç ”ç©¶ `boot/main.c` ä¸­çš„ C è¯­è¨€éƒ¨åˆ†ã€‚

### Exercise 4.

å»ºè®®é˜…è¯» 'K&R' 5.1 åˆ° 5.5 ææ¸…æ¥šæŒ‡é’ˆï¼Œæ­¤å¤–å¼„æ¸…æ¥š [pointers.c](https://pdos.csail.mit.edu/6.828/2018/labs/lab1/pointers.c) çš„è¾“å‡ºï¼Œå¦åˆ™åç»­ä¼šå¾ˆç—›è‹¦ã€‚

éœ€è¦äº†è§£ ELF äºŒè¿›åˆ¶æ–‡ä»¶æ‰èƒ½ææ¸…æ¥š `boot/main.c` ã€‚

å½“ç¼–è¯‘é“¾æ¥ä¸€ä¸ª C è¯­è¨€ç¨‹åºæ—¶ï¼Œé¦–å…ˆéœ€è¦å°† .c æ–‡ä»¶ç¼–è¯‘ä¸º .o ç»“å°¾çš„ object æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«äº†ç›¸åº”çš„äºŒè¿›åˆ¶æ ¼å¼çš„æ±‡ç¼–æŒ‡ä»¤ã€‚

é“¾æ¥å™¨å°†æ‰€æœ‰çš„ .o æ–‡ä»¶é“¾æ¥ä¸ºå•ä¸ªäºŒè¿›åˆ¶é•œåƒï¼Œä¾‹å¦‚ `obj/kern/kernel` ï¼Œè¿™æ˜¯ä¸€ä¸ª ELF æ ¼å¼çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå…¨ç§°å«åš â€œExecutable and Linkable Formatâ€ ã€‚

æ­¤å¤„å¯ä»¥ç®€å•çš„å°† ELF è®¤ä¸ºè¯¥æ–‡ä»¶å¤´éƒ¨å¸¦æœ‰åŠ è½½ä¿¡æ¯ï¼Œç„¶åæ˜¯æ˜¯ç¨‹åºéƒ¨åˆ†ï¼Œæ¯éƒ¨åˆ†éƒ½æ˜¯è¿ç»­çš„ä»£ç æˆ–æ•°æ®å—ï¼Œå°†æŒ‡å®šçš„åœ°å€åŠ è½½åˆ°å†…å­˜ä¸­ã€‚Boot Loader å°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­å¹¶å¼€å§‹æ‰§è¡Œã€‚

ELF çš„äºŒè¿›åˆ¶æ–‡ä»¶å¤´éƒ¨çš„é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œç„¶åæ˜¯é•¿åº¦å¯å˜çš„ç¨‹åºå¤´ï¼Œå…¶ä¸­åŒ…å«äº†éœ€è¦åŠ è½½çš„ç¨‹åºéƒ¨åˆ†ã€‚åœ¨ `inc/elf.h` ä¸­åŒ…å«äº† ELF æ–‡ä»¶å¤´éƒ¨çš„å®šä¹‰ã€‚

* .text: ç¨‹åºæŒ‡ä»¤.
* .rodata: åªè¯»æ•°æ®ï¼Œä¾‹å¦‚ç”± C ç¼–è¯‘å™¨ç”Ÿæˆçš„ ASCII å­—ç¬¦å¸¸é‡ã€‚(è¿™ä¸ªåªè¯»å¹¶æ²¡æœ‰åœ¨ç¡¬ä»¶å±‚é¢å®ç°)
* .data: æ•°æ®éƒ¨åˆ†ï¼ŒåŒ…å«äº†ç¨‹åºåˆå§‹åŒ–çš„æ•°æ®ï¼Œä¾‹å¦‚å£°æ˜çš„å…¨å±€å˜é‡ x = 5 ã€‚

å½“é“¾æ¥å™¨è®¡ç®—ä¸€ä¸ªç¨‹åºçš„å†…å­˜å¸ƒå±€ä¹‹æ—¶ï¼Œå®ƒä¸ºæ²¡æœ‰åˆå§‹åŒ–çš„ç¨‹åºä¿ç•™äº†ç©ºé—´ï¼Œä¾‹å¦‚ int x ï¼Œåœ¨å†…å­˜ä¸­ç´§éš.dataä¹‹åçš„ä¸€ä¸ªåä¸º.bssçš„éƒ¨åˆ†ã€‚C é»˜è®¤æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ä¸ºé›¶ï¼Œæ‰€ä»¥ .bss æ­¤æ—¶æ²¡æœ‰å­˜å‚¨å†…å®¹ï¼Œå› æ­¤é“¾æ¥å™¨åªè®°å½• .bss éƒ¨åˆ†çš„åœ°å€å’Œå¤§å°å¹¶å°†å…¶ç½®ä¸ºé›¶ã€‚

é€šè¿‡é”®å…¥æ£€æŸ¥å†…æ ¸å¯æ‰§è¡Œæ–‡ä»¶ä¸­æ‰€æœ‰éƒ¨åˆ†çš„åç§°ã€å¤§å°å’Œé“¾æ¥åœ°å€çš„å®Œæ•´åˆ—è¡¨ã€‚

    $ objdump -h obj/kern/kernel

    obj/kern/kernel:     file format elf32-i386

    Sections:
    Idx Name          Size      VMA       LMA       File off  Algn
    0 .text         00001917  f0100000  00100000  00001000  2**4
                    CONTENTS, ALLOC, LOAD, READONLY, CODE
    1 .rodata       00000714  f0101920  00101920  00002920  2**5
                    CONTENTS, ALLOC, LOAD, READONLY, DATA
    2 .stab         00003889  f0102034  00102034  00003034  2**2
                    CONTENTS, ALLOC, LOAD, READONLY, DATA
    3 .stabstr      000018af  f01058bd  001058bd  000068bd  2**0
                    CONTENTS, ALLOC, LOAD, READONLY, DATA
    4 .data         0000a300  f0108000  00108000  00009000  2**12
                    CONTENTS, ALLOC, LOAD, DATA
    5 .bss          00000648  f0112300  00112300  00013300  2**5
                    CONTENTS, ALLOC, LOAD, DATA
    6 .comment      00000023  00000000  00000000  00013948  2**0
                    CONTENTS, READONLY

VMA æ˜¯é€»è¾‘åœ°å€ï¼ŒLMA æ˜¯åŠ è½½åˆ°å†…å­˜ä¸­çš„ç‰©ç†åœ°å€ã€‚é€šå¸¸è¿™ä¸¤ä¸ªåœ°å€æ˜¯ç›¸åŒçš„ã€‚

boot loader æ ¹æ® ELF æ–‡ä»¶çš„å¤´éƒ¨å†³å®šåŠ è½½å“ªäº›éƒ¨åˆ†ã€‚ç¨‹åºå¤´éƒ¨æŒ‡å®šäº†å“ªäº›ä¿¡æ¯éœ€è¦åŠ è½½åŠå…¶åœ°å€ã€‚å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥æŸ¥çœ‹ç¨‹åºå¤´éƒ¨ã€‚

    athena% objdump -x obj/kern/kernel

ç¨‹åºå¤´éƒ¨å·²ç»åœ¨ "Program Headers" ä¸‹åˆ—å‡ºï¼ŒELF å¯¹è±¡çš„åŒºåŸŸéœ€è¦åŠ è½½åˆ°å†…å­˜ä¸­ç„¶åè¢«æ ‡è®°ä¸º "LOAD"ã€‚

æ¯ä¸ªç¨‹åºå¤´çš„å…¶ä»–ä¿¡æ¯ä¹Ÿè¢«ç»™å‡ºï¼Œå¦‚è™šæ‹Ÿåœ°å€ï¼ˆ"vaddr"ï¼‰ï¼Œç‰©ç†åœ°å€ï¼ˆ"paddr"ï¼‰ï¼Œä»¥åŠåŠ è½½åŒºåŸŸçš„å¤§å°ï¼ˆ"memsz "å’Œ "filesz"ï¼‰ã€‚

å›åˆ° `boot/main.c` æ¯ä¸€ä¸ªç¨‹åºçš„ `ph->p_pa` å­—æ®µåŒ…å«äº†æ®µçš„ç‰©ç†åœ°å€ã€‚æ­¤å¤„æ˜¯ä¸€ä¸ªçœŸæ­£çš„ç‰©ç†åœ°å€ï¼Œå°½ç®¡ ELF å¯¹è¿™ä¸ªæè¿°ä¸æ¸…æ™°ã€‚

BIOS å°† boot sector åŠ è½½åˆ°å†…å­˜ä¸­å¹¶ä» 0x7c00 å¤„å¼€å§‹ï¼Œè¿™æ˜¯ boot sector çš„åŠ è½½åœ°å€ã€‚boot sector ä»è¿™é‡Œå¼€å§‹æ‰§è¡Œã€‚è¿™ä¹Ÿæ˜¯ boot sector æ‰§è¡Œçš„åœ°æ–¹ï¼Œæ‰€ä»¥è¿™ä¹Ÿæ˜¯å®ƒçš„é“¾æ¥åœ°å€ã€‚

åœ¨ `boot/Makefrag` ä¸­é€šè¿‡ -Ttext 0x7C00 è®¾ç½®äº†å¯åŠ¨åœ°å€ã€‚

### Exercise 5.

å†æ¬¡è¿½è¸ª Boot Loader çš„å‰å‡ æ¡æŒ‡ä»¤ï¼Œæ‰¾å‡ºç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œå¦‚æœæŠŠ Boot Loader çš„é“¾æ¥åœ°å€å¼„é”™äº†ï¼Œå°±ä¼š "ä¸­æ–­ "æˆ–åšé”™äº‹ã€‚ç„¶åæŠŠ`boot/Makefrag` ä¸­çš„é“¾æ¥åœ°å€æ”¹æˆé”™è¯¯çš„ï¼Œè¿è¡Œmake cleanï¼Œç”¨makeé‡æ–°ç¼–è¯‘å®éªŒå®¤ï¼Œå¹¶å†æ¬¡è¿½è¸ªåˆ°boot loaderï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ä¸è¦å¿˜äº†æŠŠé“¾æ¥åœ°å€æ”¹å›æ¥ï¼Œç„¶åå†åšä¸€æ¬¡æ¸…ç†ã€‚

ä¿®æ”¹ `boot/Makefrag` ä¸­çš„ `-Ttext 0x7C00` ï¼ŒæŸ¥çœ‹ç»“æœï¼Œä¾‹å¦‚å°† å…¶æ”¹ä¸º `-Ttext 0x0C00` ã€‚èµ·åˆä¾æ—§åŠ è½½åˆ° 0x7c00 å¤„ï¼Œä½†æ˜¯è·³è½¬çš„æ—¶å€™å‡ºç°é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯æœ€åˆçš„æŒ‡ä»¤å¹¶ä¸ä¾èµ–åœ°å€ï¼Œè·³è½¬çš„æ—¶å€™ä¾èµ–ã€‚

![20220505143831](https://cdn.jsdelivr.net/gh/weijiew/pic/images/20220505143831.png)

å›å¤´çœ‹å†…æ ¸åŠ è½½å’Œé“¾æ¥çš„åœ°å€ï¼Œå’Œ Boot Loader ä¸åŒçš„æ˜¯ï¼Œè¿™ä¸¤ä¸ªåœ°å€å¹¶ä¸ç›¸åŒã€‚å†…æ ¸å‘Šè¯‰ Boot Loader åœ¨ä¸€ä¸ªä½çš„åœ°å€ï¼ˆ1 å…†å­—èŠ‚ï¼‰å°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä½†å®ƒå¸Œæœ›ä»ä¸€ä¸ªé«˜çš„åœ°å€æ‰§è¡Œã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­æ·±å…¥æ¢è®¨å¦‚ä½•ä½¿è¿™ä¸€å·¥ä½œã€‚

æ­¤å¤– ELF è¿˜æœ‰å¾ˆå¤šé‡è¦çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ e_entry æ˜¯ç¨‹åº entry point çš„åœ°å€ã€‚å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š

    $ objdump -f obj/kern/kernel

    obj/kern/kernel:     file format elf32-i386
    architecture: i386, flags 0x00000112:
    EXEC_P, HAS_SYMS, D_PAGED
    start address 0x0010000c

kernel æ˜¯ä» 0x0010000c å¤„å¼€å§‹æ‰§è¡Œã€‚

æ­¤æ—¶åº”å½“ç†è§£ `boot/main.c` ä¸­çš„ ELF loader ã€‚å®ƒå°†å†…æ ¸çš„æ¯ä¸ªéƒ¨åˆ†ä»ç£ç›˜ä¸Šè¯»åˆ°å†…å­˜ä¸­çš„è¯¥éƒ¨åˆ†çš„åŠ è½½åœ°å€ï¼Œç„¶åè·³è½¬åˆ°å†…æ ¸çš„å…¥å£ç‚¹ã€‚

### Exercise 6.

å¯ä»¥ä½¿ç”¨ GDB çš„ x å‘½ä»¤æ¥æŸ¥çœ‹å†…å­˜ã€‚æ­¤å¤„çŸ¥æ™“ `x/Nx ADDR` å°±å¤Ÿç”¨äº†ï¼Œåœ¨ADDRå¤„æ‰“å°Nä¸ªå­—çš„å†…å­˜ã€‚

é‡æ–°æ‰“å¼€ gdb æ£€æµ‹ï¼Œåœ¨ BIOS è¿›å…¥ Boot Loader æ—¶æ£€æŸ¥ 0x00100000 å¤„çš„ 8 ä¸ªå†…å­˜å­—ï¼Œç„¶ååœ¨ Boot Loader è¿›å…¥å†…æ ¸æ—¶å†æ¬¡æ£€æŸ¥ã€‚ä¸ºä»€ä¹ˆå®ƒä»¬ä¼šä¸åŒï¼Ÿåœ¨ç¬¬äºŒä¸ªæ–­ç‚¹å¤„æœ‰ä»€ä¹ˆï¼Ÿ(ä½ ä¸éœ€è¦ç”¨ QEMU æ¥å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œåªéœ€è¦æ€è€ƒä¸€ä¸‹ã€‚)

> ä¸åŒæ˜¯å› ä¸ºå†…æ ¸åŠ è½½è¿›æ¥äº†ï¼Œå†…æ ¸æŒ‡ä»¤ã€‚

## Part 3: The Kernel

æœ€åˆå…ˆæ‰§è¡Œæ±‡ç¼–ï¼Œç„¶åä¸º C è¯­è¨€æ‰§è¡Œåšä¸€äº›å‡†å¤‡ã€‚ä½¿ç”¨è™šæ‹Ÿå†…å­˜æ¥è§£å†³ä½ç½®ä¾èµ–çš„é—®é¢˜ã€‚

Boot Loader çš„è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯å†…æ ¸çš„è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜¯ä¸åŒçš„ï¼Œæ›´ä¸ºå¤æ‚ï¼Œé“¾æ¥å’ŒåŠ è½½åœ°å€éƒ½åœ¨ `kern/kernel.ld` çš„é¡¶éƒ¨ã€‚

OS å†…æ ¸ä¸€èˆ¬åœ¨æ¯”è¾ƒé«˜çš„è™šæ‹Ÿåœ°å€ä¸Šé“¾æ¥å’Œè¿è¡Œï¼Œä¾‹å¦‚0xf0100000ï¼Œè€Œåœ°å€ç©ºé—´çš„ä½éƒ¨åˆ†ç•™ç»™äº†ç”¨æˆ·ç¨‹åºä½¿ç”¨ã€‚

è®¸å¤šæœºå™¨åœ¨åœ°å€0xf0100000å¤„æ²¡æœ‰ä»»ä½•ç‰©ç†å†…å­˜ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½æŒ‡æœ›èƒ½åœ¨é‚£é‡Œå­˜å‚¨å†…æ ¸ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å¤„ç†å™¨çš„å†…å­˜ç®¡ç†ç¡¬ä»¶å°†è™šæ‹Ÿåœ°å€ 0xf0100000ï¼ˆå†…æ ¸ä»£ç æœŸæœ›è¿è¡Œçš„é“¾æ¥åœ°å€ï¼‰æ˜ å°„åˆ°ç‰©ç†åœ°å€0x00100000ï¼ˆå¼•å¯¼åŠ è½½å™¨å°†å†…æ ¸åŠ è½½åˆ°ç‰©ç†å†…å­˜çš„åœ°æ–¹ï¼‰ã€‚è¿™æ ·ï¼Œå°½ç®¡å†…æ ¸çš„è™šæ‹Ÿåœ°å€è¶³å¤Ÿé«˜ï¼Œå¯ä»¥ä¸ºç”¨æˆ·è¿›ç¨‹ç•™ä¸‹è¶³å¤Ÿçš„åœ°å€ç©ºé—´ï¼Œä½†å®ƒå°†è¢«åŠ è½½åˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œä½äºPCçš„RAMçš„1MBå¤„ï¼Œå°±åœ¨BIOS ROMä¸Šæ–¹ã€‚è¿™ç§æ–¹æ³•è¦æ±‚PCè‡³å°‘æœ‰å‡ å…†å­—èŠ‚çš„ç‰©ç†å†…å­˜ï¼ˆè¿™æ ·ç‰©ç†åœ°å€0x00100000æ‰è¡Œï¼‰ï¼Œä½†è¿™å¯èƒ½æ˜¯1990å¹´ä»¥ååˆ¶é€ çš„ä»»ä½•PCçš„çœŸå®æƒ…å†µã€‚

äº‹å®ä¸Šï¼Œåœ¨ä¸‹ä¸€ä¸ªå®éªŒä¸­ï¼Œæˆ‘ä»¬å°†æŠŠPCçš„æ•´ä¸ªåº•éƒ¨256MBçš„ç‰©ç†åœ°å€ç©ºé—´ï¼Œä»ç‰©ç†åœ°å€0x00000000åˆ°0x0fffffffï¼Œåˆ†åˆ«æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€0xf0000000åˆ°0xffffffffã€‚ç°åœ¨ä½ åº”è¯¥æ˜ç™½ä¸ºä»€ä¹ˆJOSåªèƒ½ä½¿ç”¨å‰256MBçš„ç‰©ç†å†…å­˜äº†ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€æ˜ å°„å‰ 4MB çš„ç‰©ç†å†…å­˜ï¼Œè¿™å°±è¶³ä»¥è®©æˆ‘ä»¬å¼€å§‹è¿è¡Œã€‚æˆ‘ä»¬ä½¿ç”¨`kern/entrypgdir.c`ä¸­æ‰‹å·¥ç¼–å†™çš„ã€é™æ€åˆå§‹åŒ–çš„é¡µç›®å½•å’Œé¡µè¡¨æ¥åšè¿™ä»¶äº‹ã€‚ç°åœ¨ï¼Œä½ ä¸éœ€è¦äº†è§£è¿™ä¸ªå·¥ä½œçš„ç»†èŠ‚ï¼Œåªéœ€è¦äº†è§£å®ƒçš„æ•ˆæœã€‚åœ¨`kern/entry.S`è®¾ç½® CR0_PG æ ‡å¿—ä¹‹å‰ï¼Œå†…å­˜å¼•ç”¨è¢«è§†ä¸ºç‰©ç†åœ°å€ï¼ˆä¸¥æ ¼æ¥è¯´ï¼Œå®ƒä»¬æ˜¯çº¿æ€§åœ°å€ï¼Œä½†`boot/boot.S`è®¾ç½®äº†ä»çº¿æ€§åœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„ï¼Œæˆ‘ä»¬æ°¸è¿œä¸ä¼šæ”¹å˜ï¼‰ã€‚ä¸€æ—¦CR0_PGè¢«è®¾ç½®ï¼Œå†…å­˜å¼•ç”¨å°±æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè¢«è™šæ‹Ÿå†…å­˜ç¡¬ä»¶ç¿»è¯‘æˆç‰©ç†åœ°å€ã€‚ entry_pgdir å°† 0xf0000000 åˆ° 0xf0400000 èŒƒå›´å†…çš„è™šæ‹Ÿåœ°å€ç¿»è¯‘æˆç‰©ç†åœ°å€0x00000000åˆ°0x00400000ï¼Œä»¥åŠè™šæ‹Ÿåœ°å€0x00000000åˆ°0x00400000åˆ°ç‰©ç†åœ°å€0x00000000åˆ°0x00400000ã€‚ä»»ä½•ä¸åœ¨è¿™ä¸¤ä¸ªèŒƒå›´å†…çš„è™šæ‹Ÿåœ°å€éƒ½ä¼šå¼•èµ·ç¡¬ä»¶å¼‚å¸¸ï¼Œç”±äºæˆ‘ä»¬è¿˜æ²¡æœ‰è®¾ç½®ä¸­æ–­å¤„ç†ï¼Œè¿™å°†å¯¼è‡´QEMUè½¬å‚¨æœºå™¨çŠ¶æ€å¹¶é€€å‡ºï¼ˆå¦‚æœä½ æ²¡æœ‰ä½¿ç”¨6.828è¡¥ä¸ç‰ˆæœ¬çš„QEMUï¼Œåˆ™ä¼šæ— ä¼‘æ­¢åœ°é‡æ–°å¯åŠ¨ï¼‰ã€‚

### Exercise 7.

ä½¿ç”¨QEMUå’ŒGDBè¿½è¸ªåˆ°JOSçš„å†…æ ¸ï¼Œåœ¨ `movl %eax, %cr0` å¤„åœæ­¢ã€‚æ£€æŸ¥0x00100000å’Œ0xf0100000å¤„çš„å†…å­˜ã€‚ç°åœ¨ï¼Œä½¿ç”¨stepi GDBå‘½ä»¤å¯¹è¯¥æŒ‡ä»¤è¿›è¡Œå•æ­¥æ“ä½œã€‚å†æ¬¡ï¼Œæ£€æŸ¥0x00100000å’Œ0xf0100000å¤„çš„å†…å­˜ã€‚ç¡®ä¿ä½ æ˜ç™½åˆšåˆšå‘ç”Ÿäº†ä»€ä¹ˆã€‚

åœ¨æ–°çš„æ˜ å°„å»ºç«‹åçš„ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯ä»€ä¹ˆï¼Œå¦‚æœæ˜ å°„æ²¡æœ‰å»ºç«‹ï¼Œå®ƒå°†ä¸èƒ½æ­£å¸¸å·¥ä½œï¼ŸæŠŠ`kern/entry.S`ä¸­çš„`movl %eax, %cr0`æ³¨é‡Šï¼Œè¿½è¸ªåˆ°å®ƒï¼Œçœ‹çœ‹ä½ æ˜¯å¦æ­£ç¡®ã€‚

![20220505155904](https://cdn.jsdelivr.net/gh/weijiew/pic/images/20220505155904.png)

åœ¨ 0x00100000 å¤„æ‰“æ–­ç‚¹ï¼Œæ¯”è¾ƒä¸¤ä¸ªåœ°å€ä¸­å­˜å‚¨çš„æ•°æ®åå‘ç°ä¸ä¸€æ ·ã€‚

![20220505160121](https://cdn.jsdelivr.net/gh/weijiew/pic/images/20220505160121.png)

> ç„¶åæ‰§è¡Œå‡ æ¡æŒ‡ä»¤ï¼Œæ‰§è¡Œå®Œ `mov    %eax,%cr0` åå‘ç°ä¸¤ä¸ªåœ°å€ä¸­å­˜å‚¨çš„æ•°æ®ä¸€è‡´ã€‚è¯´æ˜æ­¤æ—¶å¯ç”¨äº†é¡µè¡¨æ˜å®Œæˆäº†åœ°å€æ˜ å°„ã€‚

å¤§å¤šæ•°äººè®¤ä¸º printf() è¿™æ ·çš„å‡½æ•°æ˜¯ç†æ‰€å½“ç„¶çš„ï¼Œæœ‰æ—¶ç”šè‡³è®¤ä¸ºå®ƒä»¬æ˜¯Cè¯­è¨€çš„ "åŸè¯­"ã€‚ä½†æ˜¯åœ¨æ“ä½œç³»ç»Ÿçš„å†…æ ¸ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»è‡ªå·±å®ç°æ‰€æœ‰çš„I/Oã€‚

### Formatted Printing to the Console

é˜…è¯» `kern/printf.c`ã€`lib/printfmt.c` å’Œ `kern/console.c`ï¼Œå¹¶ç¡®ä¿ä½ ç†è§£å®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚åœ¨åé¢çš„å®éªŒä¸­ä¼šæ¸…æ¥šä¸ºä»€ä¹ˆ `printfmt.c` ä½äºå•ç‹¬çš„ lib ç›®å½•ä¸­ã€‚

`kern/printf.c` ä¸­çš„ `cprintf()` å‡½æ•°è°ƒç”¨äº† `vcprintf()` å‡½æ•°ï¼Œè¯¥å‡½æ•°åˆè°ƒç”¨äº† `lib/printfmt.c` ä¸­çš„ `vprintfmt()` å‡½æ•°ã€‚

	va_start(ap, fmt);
	cnt = vcprintf(fmt, ap);
	va_end(ap);

æ¥ä¸‹æ¥ç ”ç©¶ `cprintf()` å‡½æ•°ï¼Œå‡½æ•°ç­¾åæ˜¯ `int cprintf(const char *fmt, ...)` å…¶ä¸­ ... è¡¨ç¤ºå¯å˜å‚æ•°ã€‚

ç„¶åæ˜¯ [va_start](https://en.cppreference.com/w/c/variadic/va_start) ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯å°†å¯å˜å‚æ•°æ”¾ç½®åˆ° ap ä¸­ã€‚

ç„¶åè°ƒç”¨ vcprintf å‡½æ•°ï¼Œå°†å¾—åˆ°çš„å‚æ•° ap ä¼ è¿›å»ï¼Œæœ€åè°ƒç”¨ `va_end` é‡Šæ”¾å‚æ•°åˆ—è¡¨ã€‚æ­¤å¤–ï¼Œè¿™éƒ¨åˆ†è¿˜æ¶‰åŠåˆ°äº† va_arg ï¼Œåé¢ä¼šç”¨åˆ°ï¼Œä¾‹å¦‚ `va_arg(*ap, int)` è¡¨ç¤ºç”¨ int æ¥è§£æ ap ã€‚


å…¶ä¸­ putch å‡½æ•°ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œè€Œ putch å‡½æ•°è°ƒç”¨äº† cputchar å‡½æ•°ï¼Œè¯¥å‡½æ•°å†æ¬¡è°ƒç”¨äº† cons_putc å‡½æ•°ï¼Œæ ¹æ®æ³¨é‡Šå¯çŸ¥è¯¥å‡½æ•°è´Ÿè´£å°†å­—ç¬¦è¾“å‡ºåˆ°ç»ˆç«¯ã€‚æ ¹æ®è°ƒç”¨å…³ç³»ï¼Œå¯ä»¥ç®€å•çš„è®¤ä¸º putch å®ç°äº†å°†æ•°æ®æ‰“å°åˆ°ç»ˆç«¯çš„åŠŸèƒ½ï¼Œè‡³äºå®ç°ç»†èŠ‚åç»­å†ç ”ç©¶ã€‚

æ¥ä¸‹æ¥å›å¤´ç ”ç©¶ `lib/printfmt.c` ä¸­çš„ `vprintfmt()` å‡½æ•°ï¼Œå› ä¸º `kern/printf.c` ä¸­çš„ `cprintf()` æœ€ç»ˆè°ƒç”¨äº†è¯¥å‡½æ•°ã€‚

```vprintfmt(void (*putch)(int, void*), void *putdat, const char *fmt, va_list ap)```

è¯¥å‡½æ•°çš„å‡½æ•°ç­¾åä¸­å…±å››ä¸ªå‚æ•°ï¼Œä¸‹é¢æ˜¯å››ä¸ªå‚æ•°çš„è§£é‡Šï¼š

1. ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ putch å‡½æ•°ï¼Œä¹‹å‰å·²ç»è§£é‡Šè¿‡äº†ï¼Œè´Ÿè´£å®ç°æ‰“å°åˆ°ç»ˆç«¯ã€‚
2. ç¬¬äºŒä¸ªå‚æ•° putdat åˆå§‹å€¼ä¸ºé›¶ï¼Œç›®å‰è¿˜ä¸çŸ¥é“è´Ÿè´£ä»€ä¹ˆåŠŸèƒ½ã€‚
3. ç¬¬ä¸‰ä¸ªå‚æ•° fmt æ˜¯è¾“å…¥çš„å­—ç¬¦ä¸²ã€‚
4. ç¬¬å››ä¸ªå‚æ•° ap æ˜¯ va_list ç±»å‹ï¼Œè¿™ä¸ªå‚æ•°å®ç°äº†å¯å˜å‚æ•°ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å¤„ç†ä¸åŒæ•°é‡çš„å‚æ•°ã€‚

cons_putc åˆ†åˆ«è°ƒç”¨äº† serial_putcï¼Œlpt_putc å’Œ cga_putc ä¸‰ä¸ªå‡½æ•°ã€‚

### Exercise 8.

æˆ‘ä»¬çœç•¥äº†ä¸€å°æ®µä»£ç --ä½¿ç”¨"%o "å½¢å¼çš„æ¨¡å¼æ‰“å°å…«è¿›åˆ¶æ•°å­—æ‰€éœ€çš„ä»£ç ã€‚æ‰¾åˆ°å¹¶å¡«å…¥è¿™ä¸ªä»£ç ç‰‡æ®µã€‚

		case 'u':
			num = getuint(&ap, lflag);
			base = 10;
			goto number;

		// (unsigned) octal
		case 'o':
			// Replace this with your code.
			num = getuint(&ap, lflag);
			base = 8;
			goto number;
			break;


å›ç­”ä»¥ä¸‹é—®é¢˜: 

1. è§£é‡Šä¸€ä¸‹ printf.c å’Œ console.c ä¹‹é—´çš„æ¥å£ã€‚å…·ä½“æ¥è¯´ï¼Œconsole.cè¾“å‡ºäº†ä»€ä¹ˆå‡½æ•°ï¼Ÿè¿™ä¸ªå‡½æ•°æ˜¯å¦‚ä½•è¢«printf.cä½¿ç”¨çš„ï¼Ÿ

printf.c ä¸­çš„ putch() å‡½æ•°è°ƒç”¨äº† console.c ä¸­çš„ cputchar() å‡½æ•°ï¼Œè¯¥å‡½æ•°å†æ¬¡è°ƒç”¨äº† cons_putc() å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£å°†æ•°æ®æ‰“å°åˆ°ç»ˆç«¯ã€‚

2. ä» console.c ä¸­è§£é‡Šå¦‚ä¸‹ï¼š

```c
    1      if (crt_pos >= CRT_SIZE) {
    2              int i;
    3              memmove(crt_buf, crt_buf + CRT_COLS, (CRT_SIZE - CRT_COLS) * sizeof(uint16_t));
    4              for (i = CRT_SIZE - CRT_COLS; i < CRT_SIZE; i++)
    5                      crt_buf[i] = 0x0700 | ' ';
    6              crt_pos -= CRT_COLS;
    7      }
```

è¿™æ®µå‡½æ•°æºè‡ª `console.c` æ–‡ä»¶ä¸­çš„ `cga_putc()` å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè¢« `cons_putc()` å‡½æ•°æ‰€è°ƒç”¨ã€‚æ ¹æ®æ³¨é‡Šå¯çŸ¥ï¼Œ`cons_putc()` è´Ÿè´£å°†æ•°æ®æ‰“å°åˆ°ç»ˆç«¯ï¼Œé‚£ä¹ˆ `cga_putc()` åˆ™æ˜¯è´Ÿè´£å…·ä½“å®ç°å¦‚ä½•æ‰“å°åˆ°ç»ˆç«¯ã€‚

ç„¶åç ”ç©¶ `void* memmove( void* dest, const void* src, std::size_t count );` ä» src å¤„å¤åˆ¶ count å¤§å°çš„æ•°æ®åˆ° dest ä¸Šã€‚æœ€ååˆ†æ `memmove(crt_buf, crt_buf + CRT_COLS, (CRT_SIZE - CRT_COLS) * sizeof(uint16_t));` å…¶å®å°±æ˜¯å°†å½“å‰å±å¹•ä¸Šçš„æ•°æ®å‘ä¸Šç§»åŠ¨ä¸€è¡Œã€‚

æœ€åçš„ for å¾ªç¯å°±æ˜¯å°†æœ€æ–°å†™å…¥çš„éƒ¨åˆ†(crt_pos >= CRT_SIZE)æ‰“å°å‡ºæ¥ã€‚

3. å¯¹äºä¸‹é¢çš„é—®é¢˜ï¼Œä½ å¯èƒ½å¸Œæœ›å‚è€ƒç¬¬2è®²çš„æ³¨é‡Šã€‚è¿™äº›ç¬”è®°æ¶µç›–äº†GCCåœ¨X86ä¸Šçš„è°ƒç”¨æƒ¯ä¾‹ã€‚

* é€æ­¥è·Ÿè¸ªä»¥ä¸‹ä»£ç çš„æ‰§è¡Œã€‚

    int x = 1, y = 3, z = 4;
    cprintf("x %d, y %x, z %d\n", x, y, z);

* åœ¨å¯¹cprintf()çš„è°ƒç”¨ä¸­ï¼ŒfmtæŒ‡å‘ä»€ä¹ˆï¼ŸapæŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ

åˆ—å‡ºå¯¹cons_putcã€va_argå’Œvcprintfçš„æ¯ä¸ªè°ƒç”¨ï¼ˆæŒ‰æ‰§è¡Œé¡ºåºï¼‰ã€‚å¯¹äºcons_putcï¼Œä¹Ÿè¦åˆ—å‡ºå…¶å‚æ•°ã€‚å¯¹äºva_argï¼Œåˆ—å‡ºè°ƒç”¨å‰åapæ‰€æŒ‡å‘çš„å†…å®¹ã€‚å¯¹äºvcprintfï¼Œåˆ—å‡ºå…¶ä¸¤ä¸ªå‚æ•°çš„å€¼ã€‚


> é¦–å…ˆç ”ç©¶ fmt ï¼šå°†ä¸Šè¿°ä»£ç å†™å…¥ `kern/monitor.c` ä¸­çš„ `mon_backtrace()` å‡½æ•°ä¸­ï¼Œç„¶åå¼€å§‹è°ƒè¯•ã€‚

> ä½¿ç”¨ `b mon_backtrace` æ‰“æ–­ç‚¹ï¼Œä½¿ç”¨ c æ‰§è¡Œåˆ°è¿™ä¸€æ­¥ï¼Œç„¶åä½¿ç”¨ `s` è¿›å…¥ `cprintf()` å‡½æ•°ä¸­ï¼Œå¤šæ‰§è¡Œä¸¤æ­¥åå‘ç° `fmt = "x %d, y %x, z %d\n"` ã€‚

![20220505225217](https://cdn.jsdelivr.net/gh/weijiew/pic/images/20220505225217.png)

> æ¥ä¸‹æ¥ç ”ç©¶ ap ï¼Œç»è¿‡æ•°æ¬¡è°ƒç”¨ va_arg ï¼Œap ä» 1 3 4 å˜ä¸º 3 4 å˜ä¸º 4 å†ä¸ºç©ºã€‚

4. è¿è¡Œä»¥ä¸‹ä»£ç ã€‚

    unsigned int i = 0x00646c72;
    cprintf("H%x Wo%s", 57616, &i);


è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿè§£é‡Šä¸€ä¸‹è¿™ä¸ªè¾“å‡ºæ˜¯å¦‚ä½•æŒ‰ç…§å‰é¢ç»ƒä¹ çš„æ–¹å¼ä¸€æ­¥æ­¥å¾—å‡ºçš„ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªASCIIè¡¨ï¼Œå°†å­—èŠ‚æ˜ å°„åˆ°å­—ç¬¦ã€‚è¿™ä¸ªè¾“å‡ºå–å†³äºx86æ˜¯å°ç«¯çš„äº‹å®ã€‚å¦‚æœx86æ˜¯big-endiançš„ï¼Œä½ è¦æŠŠiè®¾ç½®æˆä»€ä¹ˆæ ·å­æ‰èƒ½äº§ç”ŸåŒæ ·çš„è¾“å‡ºï¼Ÿä½ æ˜¯å¦éœ€è¦å°†57616æ”¹ä¸ºä¸åŒçš„å€¼ï¼Ÿ

> è¾“å‡º "He110 World" å…¶ä¸­ 5760 çš„äºŒè¿›åˆ¶å½¢å¼æ˜¯ e110 ã€‚è‡³äº 0x00646c72 ä¸ºä»€ä¹ˆæ˜¾ç¤ºä¸º rld ï¼Œé¦–å…ˆè¦ææ¸…æ¥šå¤§å°ç«¯ã€‚

> æˆ‘è®¤ä¸ºåº”å½“ä»è¯»å–é¡ºåºçš„è§’åº¦æ¥çœ‹ï¼Œé€šå¸¸äººç±»çš„è¯»å–ä¹ æƒ¯æ˜¯ä»é«˜ä½å‘åœ°ä½é˜…è¯»ï¼Œä¹Ÿå°±æ˜¯ä»å·¦å‘å³ã€‚ä½†æ˜¯å¯¹äºè®¡ç®—æœºè€Œè¨€ä¼˜å…ˆå¤„ç†åœ°ä½æ˜¾ç„¶æ•ˆç‡æ›´é«˜ï¼Œæ‰€ä»¥æ•°å­—çš„åœ°ä½å­˜å‚¨åœ¨ä½åœ°å€éƒ¨åˆ†ï¼Œæ•°æ®çš„é«˜ä½å­˜å‚¨åœ¨é«˜åœ°å€éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯å°ç«¯ã€‚è€Œå¤§ç«¯åä¹‹ï¼Œåœ°ä½å­˜å‚¨åœ¨é«˜åœ°å€éƒ¨åˆ†ï¼Œå°ç«¯å­˜å‚¨åœ¨ä½åœ°å€éƒ¨åˆ†ã€‚

    ä½åœ°å€  =====> é«˜åœ°å€
    å°ç«¯ï¼š  72  6c  64 00
    å¤§ç«¯ï¼š  00  64  6c 72

> æŸ¥ ASCII è¡¨å¯çŸ¥ 0x72 0x6c 0x64 0x00 åˆ†åˆ«è¡¨ç¤º 'r' 'l' 'd' '\0' ã€‚å¦‚æœåœ¨å¤§ç«¯çš„ç³»ç»Ÿä¸Šè¾“å‡ºç›¸åŒçš„å†…å®¹éœ€è¦æ”¹ä¸º 0x726c6400 ã€‚

5. åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œ'y='åé¢è¦æ‰“å°ä»€ä¹ˆï¼Ÿ(æ³¨æ„ï¼šç­”æ¡ˆä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„æ•°å€¼ã€‚)ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Ÿ

    cprintf("x=%d y=%d", 3);

> è¾“å‡º x=3 y=-267321544 ç¬¬ä¸€ä¸ªè¾“å‡º 3 æ˜¯å› ä¸ºå‚æ•°å°±æ˜¯ 3 è€Œç¬¬äºŒä¸ªè¾“å‡ºåˆ™æ˜¯è¯»å–äº†ç›¸é‚»åœ°å€ä¸­çš„å†…å®¹ã€‚

6. å‡è®¾GCCæ”¹å˜äº†å®ƒçš„è°ƒç”¨æƒ¯ä¾‹ï¼Œä½¿å®ƒæŒ‰å£°æ˜é¡ºåºæŠŠå‚æ•°æ¨åˆ°å †æ ˆä¸Šï¼Œè¿™æ ·æœ€åä¸€ä¸ªå‚æ•°å°±è¢«æ¨åˆ°äº†ã€‚ä½ è¦å¦‚ä½•æ”¹å˜cprintfæˆ–å®ƒçš„æ¥å£ï¼Œä½¿å®ƒä»ç„¶æœ‰å¯èƒ½ä¼ é€’å¯å˜æ•°é‡çš„å‚æ•°ï¼Ÿ

> `cprintf` å‡½æ•°çš„ä¸¤ä¸ªå‚æ•°äº¤æ¢é¡ºåºå³å¯ã€‚

7. æŒ‘æˆ˜ï¼Œç»ˆç«¯æ‰“å°å‡ºå½©è‰²æ–‡æœ¬ã€‚

> å†™åˆ°è¿™é‡Œå·²ç»èŠ±äº†å¾ˆé•¿æ—¶é—´äº†ï¼Œå…ˆè·³è¿‡ã€‚

### The Stack

### Exercise 9. 

ç¡®å®šå†…æ ¸åœ¨å“ªé‡Œåˆå§‹åŒ–å®ƒçš„å †æ ˆï¼Œä»¥åŠå®ƒçš„å †æ ˆåœ¨å†…å­˜ä¸­çš„ç¡®åˆ‡ä½ç½®ã€‚å†…æ ¸æ˜¯å¦‚ä½•ä¸ºå…¶å †æ ˆä¿ç•™ç©ºé—´çš„ï¼Ÿå †æ ˆæŒ‡é’ˆè¢«åˆå§‹åŒ–ä¸ºæŒ‡å‘è¿™ä¸ªä¿ç•™åŒºåŸŸçš„å“ªä¸ª "æœ«ç«¯"ï¼Ÿ

esp å¯„å­˜å™¨æŒ‡å‘æ ˆé¡¶ï¼Œebp æŒ‡å‘æ ˆåº•ã€‚åœ¨ 32 ä½æ¨¡å¼ä¸‹ï¼Œå †æ ˆåªèƒ½å®¹çº³ 32 ä½çš„å€¼ï¼Œesp æ€»èƒ½è¢« 4 æ•´é™¤ã€‚å½“è°ƒç”¨ C å‡½æ•°ä¹‹æ—¶ï¼Œé¦–å…ˆå°† esp ä¸­çš„å€¼å¤åˆ¶åˆ° ebp ä¸­ï¼Œç„¶å esp å‘ä¸‹ç”Ÿé•¿å¼€è¾Ÿç©ºé—´ã€‚å¯ä»¥é€šè¿‡ ebp æŒ‡é’ˆé“¾æ¥å›æº¯å †æ ˆè¿›è€Œç¡®å®šå‡½æ•°çš„è°ƒç”¨å…³ç³»ã€‚è¿™ä¸ªåŠŸèƒ½å¾ˆæœ‰ç”¨ï¼Œä¾‹å¦‚ä¸€ä¸ªå‡½æ•°æ–­è¨€å¤±è´¥æˆ– panic ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡å›æº¯å †æ ˆæ¥ç¡®å®šå‡ºç°é—®é¢˜å‡½æ•°ã€‚

> 1. åœ¨ `kernel/entry.S` ä¸­ 77 è¡Œçš„ `movl	$(bootstacktop),%esp` æŒ‡ä»¤å¼€å§‹åˆå§‹åŒ–æ ˆï¼Œè¯¥æŒ‡ä»¤è®¾ç½®äº†æ ˆå¸§ã€‚
> 2. æ ¹æ® `.space		KSTKSIZE` æ¥ç¡®å®šæ ˆå¤§å°ï¼ŒKSTKSIZE åœ¨ `inc/memlayout.h` å®šä¹‰å¤§å°ä¸º 8*PGSIZE ï¼Œè€Œ PGSIZE ä¸º 4096 å­—èŠ‚ã€‚
> 3. æ ¹æ®ç›¸åº”çš„æ±‡ç¼–æ–‡ä»¶ `obj/kern/kernel.asm` ç¬¬ 58 è¡Œå¯çŸ¥ï¼Œæ ˆå¸§çš„è™šæ‹Ÿåœ°å€ä¸º 0xf0110000ã€‚å› ä¸ºæ ˆæ˜¯å‘ä¸‹ç”Ÿé•¿ï¼Œæ‰€ä»¥æ ¹æ® KSTKSIZE å¯ä»¥ç¡®å®šæ ˆçš„æœ«ç«¯ã€‚

### Exercise 10. 

ä¸ºäº†ç†Ÿæ‚‰x86ä¸Šçš„Cè¯­è¨€è°ƒç”¨ä¹ æƒ¯ï¼Œåœ¨`obj/kern/kernel.asm`ä¸­æ‰¾åˆ°`test_backtrace`å‡½æ•°çš„åœ°å€ï¼Œåœ¨é‚£é‡Œè®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œå¹¶æ£€æŸ¥å†…æ ¸å¯åŠ¨åæ¯æ¬¡è°ƒç”¨è¯¥å‡½æ•°æ—¶å‘ç”Ÿçš„æƒ…å†µã€‚test_backtraceçš„æ¯ä¸ªé€’å½’åµŒå¥—å±‚åœ¨å †æ ˆä¸Šæ¨å¤šå°‘ä¸ª32ä½å­—ï¼Œè¿™äº›å­—æ˜¯ä»€ä¹ˆï¼Ÿ

å®ç° `kern/monitor.c` æ–‡ä»¶ä¸­çš„ `mon_backtrace()` å‡½æ•°ã€‚`inc/x86.h`ä¸­çš„`read_ebp()`å‡½æ•°å¾ˆæœ‰ç”¨ã€‚

å›æº¯å‡½æ•°åº”è¯¥ä»¥ä¸‹åˆ—æ ¼å¼æ˜¾ç¤ºå‡½æ•°è°ƒç”¨æ¡†æ¶çš„æ¸…å•ã€‚

        Stack backtrace:
        ebp f0109e58  eip f0100a62  args 00000001 f0109e80 f0109e98 f0100ed2 00000031
        ebp f0109ed8  eip f01000d6  args 00000000 00000000 f0100058 f0109f28 00000061
        ...

æ¯ä¸€è¡Œéƒ½åŒ…å«ä¸€ä¸ª ebp ã€ eip å’Œ args ã€‚ebp å€¼è¡¨ç¤ºè¯¥å‡½æ•°æ‰€ä½¿ç”¨çš„è¿›å…¥å †æ ˆçš„åŸºæœ¬æŒ‡é’ˆï¼šå³åˆšè¿›å…¥å‡½æ•°åå †æ ˆæŒ‡é’ˆçš„ä½ç½®ï¼Œå‡½æ•°åºè¨€ä»£ç è®¾ç½®äº†åŸºæœ¬æŒ‡é’ˆã€‚ eip å€¼æ˜¯è¯¥å‡½æ•°çš„è¿”å›æŒ‡ä»¤æŒ‡é’ˆï¼šå½“å‡½æ•°è¿”å›æ—¶ï¼Œæ§åˆ¶å°†è¿”å›åˆ°è¯¥æŒ‡ä»¤åœ°å€ã€‚è¿”å›æŒ‡ä»¤æŒ‡é’ˆé€šå¸¸æŒ‡å‘è°ƒç”¨æŒ‡ä»¤ä¹‹åçš„æŒ‡ä»¤ï¼ˆä¸ºä»€ä¹ˆå‘¢ï¼‰ã€‚æœ€åï¼Œåœ¨argsåé¢åˆ—å‡ºçš„äº”ä¸ªåå…­è¿›åˆ¶å€¼æ˜¯æœ‰å…³å‡½æ•°çš„å‰äº”ä¸ªå‚æ•°ï¼Œè¿™äº›å‚æ•°åœ¨å‡½æ•°è¢«è°ƒç”¨ä¹‹å‰ä¼šè¢«æ¨åˆ°å †æ ˆä¸­ã€‚å½“ç„¶ï¼Œå¦‚æœå‡½æ•°è¢«è°ƒç”¨æ—¶çš„å‚æ•°å°‘äº5ä¸ªï¼Œé‚£ä¹ˆè¿™5ä¸ªå€¼å°±ä¸ä¼šå…¨éƒ¨æœ‰ç”¨ã€‚(ä¸ºä»€ä¹ˆå›æº¯ä»£ç ä¸èƒ½æ£€æµ‹åˆ°å®é™…æœ‰å¤šå°‘ä¸ªå‚æ•°ï¼Ÿå¦‚ä½•æ‰èƒ½è§£å†³è¿™ä¸ªé™åˆ¶å‘¢ï¼Ÿï¼‰

æ‰“å°çš„ç¬¬ä¸€è¡Œåæ˜ å½“å‰æ‰§è¡Œçš„å‡½æ•°ï¼Œå³ mon_backtrace æœ¬èº«ï¼Œç¬¬äºŒè¡Œåæ˜ è°ƒç”¨  mon_backtrace çš„å‡½æ•°ï¼Œç¬¬ä¸‰è¡Œåæ˜ è°ƒç”¨è¯¥å‡½æ•°çš„å‡½æ•°ï¼Œä»¥æ­¤ç±»æ¨ã€‚åº”è¯¥æ‰“å°æ‰€æœ‰æœªå®Œæˆçš„å †æ ˆå¸§ã€‚é€šè¿‡ç ”ç©¶ `kern/entry.S` ï¼Œä½ ä¼šå‘ç°æœ‰ä¸€ç§ç®€å•çš„æ–¹æ³•å¯ä»¥å‘Šè¯‰ä½ ä½•æ—¶åœæ­¢ã€‚

ä»¥ä¸‹æ˜¯ä½ åœ¨ã€ŠK&Rã€‹ç¬¬äº”ç« ä¸­è¯»åˆ°çš„å‡ ä¸ªå…·ä½“è¦ç‚¹ï¼Œå€¼å¾—ä½ åœ¨ä¸‹é¢çš„ç»ƒä¹ å’Œä»Šåçš„å®éªŒä¸­è®°ä½ã€‚

1. å¦‚æœint *p = (int*)100ï¼Œé‚£ä¹ˆ(int)p + 1å’Œ(int)(p + 1)æ˜¯ä¸åŒçš„æ•°å­—ï¼šç¬¬ä¸€ä¸ªæ˜¯101ï¼Œä½†ç¬¬äºŒä¸ªæ˜¯104ã€‚å½“æŠŠä¸€ä¸ªæ•´æ•°åŠ åˆ°ä¸€ä¸ªæŒ‡é’ˆä¸Šæ—¶ï¼Œå°±åƒç¬¬äºŒç§æƒ…å†µä¸€æ ·ï¼Œè¿™ä¸ªæ•´æ•°éšå«åœ°ä¹˜ä»¥æŒ‡é’ˆæ‰€æŒ‡å‘çš„å¯¹è±¡çš„å¤§å°ã€‚
2. p[i]è¢«å®šä¹‰ä¸ºä¸*(p+i)ç›¸åŒï¼ŒæŒ‡çš„æ˜¯pæ‰€æŒ‡å‘çš„å†…å­˜ä¸­çš„ç¬¬iä¸ªå¯¹è±¡ã€‚å½“å¯¹è±¡å¤§äºä¸€ä¸ªå­—èŠ‚æ—¶ï¼Œä¸Šé¢çš„åŠ æ³•è§„åˆ™æœ‰åŠ©äºè¿™ä¸ªå®šä¹‰å‘æŒ¥ä½œç”¨ã€‚
3. &p[i]ä¸(p+i)ç›¸åŒï¼Œäº§ç”Ÿpæ‰€æŒ‡å‘çš„å†…å­˜ä¸­çš„ç¬¬iä¸ªå¯¹è±¡çš„åœ°å€ã€‚

å°½ç®¡å¤§å¤šæ•°Cè¯­è¨€ç¨‹åºä¸éœ€è¦åœ¨æŒ‡é’ˆå’Œæ•´æ•°ä¹‹é—´è¿›è¡Œè½¬æ¢ï¼Œä½†æ“ä½œç³»ç»Ÿç»å¸¸éœ€è¦ã€‚æ¯å½“ä½ çœ‹åˆ°æ¶‰åŠå†…å­˜åœ°å€çš„åŠ æ³•æ—¶ï¼Œè¦é—®è‡ªå·±è¿™åˆ°åº•æ˜¯æ•´æ•°åŠ æ³•è¿˜æ˜¯æŒ‡é’ˆåŠ æ³•ï¼Œå¹¶ç¡®ä¿è¢«åŠ çš„å€¼è¢«é€‚å½“åœ°ä¹˜ä»¥ã€‚

> ebp çš„åˆå§‹å€¼ä¸º 0 ï¼Œå¯ä»¥åˆ¤æ–­æ˜¯å¦ä¸ºé›¶æ¥åœæ­¢å¾ªç¯ã€‚

```cpp
	uint32_t ebp, eip;
	cprintf("Stack backtrace:\n");
	for (ebp = read_ebp(); ebp != 0; ebp = *((uint32_t *)ebp)) {
		eip = *((uint32_t *)ebp + 1);
		cprintf(" ebp %08x eip %08x args %08x %08x %08x %08x %08x\n",
		ebp, eip, *((uint32_t *)ebp + 2),
		*((uint32_t *)ebp + 3), *((uint32_t *)ebp + 4),
		*((uint32_t *)ebp + 5), *((uint32_t *)ebp + 6));
	}
```

### Exercise 11. 

ä½¿ç”¨ make grade éªŒè¯ã€‚

å¦‚æœä½¿ç”¨ read_ebp()ï¼Œä¸­é—´å˜é‡å¯èƒ½ä¼šè¢«ä¼˜åŒ–æ‰ï¼Œè¿›è€Œå¯¼è‡´è·Ÿè¸ªå †æ ˆä¿¡æ¯æ—¶çœ‹ä¸åˆ°å®Œæ•´çš„å †æ ˆä¿¡æ¯ã€‚

åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œä½ çš„å›æº¯å‡½æ•°åº”è¯¥ç»™ä½ å †æ ˆä¸Šå¯¼è‡´ mon_backtrace() è¢«æ‰§è¡Œçš„å‡½æ•°è°ƒç”¨è€…çš„åœ°å€ã€‚ç„¶è€Œï¼Œåœ¨å®è·µä¸­ï¼Œä½ ç»å¸¸æƒ³çŸ¥é“è¿™äº›åœ°å€æ‰€å¯¹åº”çš„å‡½æ•°åç§°ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½æƒ³çŸ¥é“å“ªäº›å‡½æ•°å¯èƒ½åŒ…å«ä¸€ä¸ªå¯¼è‡´å†…æ ¸å´©æºƒçš„é”™è¯¯ã€‚

ä¸ºäº†å¸®åŠ©ä½ å®ç°è¿™ä¸€åŠŸèƒ½ï¼Œæˆ‘ä»¬æä¾›äº†å‡½æ•° debuginfo_eip()ï¼Œå®ƒåœ¨ç¬¦å·è¡¨ä¸­æŸ¥æ‰¾eipå¹¶è¿”å›è¯¥åœ°å€çš„è°ƒè¯•ä¿¡æ¯ã€‚è¿™ä¸ªå‡½æ•°åœ¨kern/kdebug.cä¸­å®šä¹‰ã€‚

åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œä½ çš„å›æº¯å‡½æ•°åº”è¯¥ç»™ä½ å †æ ˆä¸Šå¯¼è‡´ mon_backtrace() è¢«æ‰§è¡Œçš„å‡½æ•°è°ƒç”¨è€…çš„åœ°å€ã€‚ç„¶è€Œï¼Œåœ¨å®è·µä¸­ï¼Œä½ ç»å¸¸æƒ³çŸ¥é“è¿™äº›åœ°å€æ‰€å¯¹åº”çš„å‡½æ•°åç§°ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½æƒ³çŸ¥é“å“ªäº›å‡½æ•°å¯èƒ½åŒ…å«ä¸€ä¸ªå¯¼è‡´å†…æ ¸å´©æºƒçš„é”™è¯¯ã€‚

ä¸ºäº†å¸®åŠ©ä½ å®ç°è¿™ä¸€åŠŸèƒ½ï¼Œæˆ‘ä»¬æä¾›äº†å‡½æ•° debuginfo_eip() ï¼Œå®ƒåœ¨ç¬¦å·è¡¨ä¸­æŸ¥æ‰¾ eip å¹¶è¿”å›è¯¥åœ°å€çš„è°ƒè¯•ä¿¡æ¯ã€‚è¿™ä¸ªå‡½æ•°åœ¨kern/kdebug.cä¸­å®šä¹‰ã€‚

é€šè¿‡ `debuginfo_eip(addr, info)` æ¥æŸ¥çœ‹ eip ä¸­æ›´å¤šçš„ä¿¡æ¯ï¼Œå…·ä½“åŠŸèƒ½æ˜¯å°†åœ°å€ addr å¤„çš„å†…å®¹å¡«å…¥ info ä¸­ã€‚å¦‚æœæ‰¾åˆ°ä¿¡æ¯å°±è¿”å›é›¶ï¼Œå¦‚æœæ²¡æœ‰æŸ¥åˆ°ä¿¡æ¯å°±è¿”å›è´Ÿæ•°ï¼Œ

### Exercise 12. 

ä¿®æ”¹ä½ çš„å †æ ˆå›æº¯å‡½æ•°ï¼Œä¸ºæ¯ä¸ª eip æ˜¾ç¤ºå‡½æ•°åã€æºæ–‡ä»¶åå’Œä¸è¯¥ eip å¯¹åº”çš„è¡Œå·ã€‚

åœ¨ debuginfo_eip ä¸­ï¼Œ__STAB_* æ¥è‡ªå“ªé‡Œï¼Ÿè¿™ä¸ªé—®é¢˜æœ‰ä¸€ä¸ªå¾ˆé•¿çš„ç­”æ¡ˆï¼›ä¸ºäº†å¸®åŠ©ä½ å‘ç°ç­”æ¡ˆï¼Œè¿™é‡Œæœ‰ä¸€äº›ä½ å¯èƒ½æƒ³åšçš„äº‹æƒ…ã€‚

* åœ¨kern/kernel.ldæ–‡ä»¶ä¸­æŸ¥æ‰¾__STAB_*ã€‚
* è¿è¡Œ objdump -h obj/kern/kernel
* è¿è¡Œobjdump -G obj/kern/kernel
* è¿è¡Œgcc -pipe -nostdinc -O2 -fno-builtin -I. -MD -Wall -Wno-format -DJOS_KERNEL -gstabs -c -S kern/init.cï¼Œå¹¶æŸ¥çœ‹init.sã€‚
* çœ‹çœ‹bootloaderæ˜¯å¦åœ¨å†…å­˜ä¸­åŠ è½½ç¬¦å·è¡¨ä½œä¸ºåŠ è½½å†…æ ¸äºŒè¿›åˆ¶çš„ä¸€éƒ¨åˆ†
* å®Œæˆdebuginfo_eipçš„å®ç°ï¼Œæ’å…¥å¯¹stab_binsearchçš„è°ƒç”¨ï¼Œä»¥æ‰¾åˆ°åœ°å€çš„è¡Œå·ã€‚


	stab_binsearch(stabs, &lline, &rline, N_SLINE, addr);
	info->eip_line = lline > rline ? -1 : stabs[rline].n_desc;

åœ¨å†…æ ¸ç›‘æ§å™¨ä¸­æ·»åŠ ä¸€ä¸ªå›æº¯å‘½ä»¤ï¼Œå¹¶æ‰©å±•ä½ çš„mon_backtraceçš„å®ç°ï¼Œä»¥è°ƒç”¨debuginfo_eipå¹¶ä¸ºæ¯ä¸ªå †æ ˆå¸§æ‰“å°ä¸€è¡Œã€‚

        Stack backtrace:
        ebp f0109e58  eip f0100a62  args 00000001 f0109e80 f0109e98 f0100ed2 00000031
        ebp f0109ed8  eip f01000d6  args 00000000 00000000 f0100058 f0109f28 00000061

    K> backtrace
    Stack backtrace:
    ebp f010ff78  eip f01008ae  args 00000001 f010ff8c 00000000 f0110580 00000000
            kern/monitor.c:143: monitor+106
    ebp f010ffd8  eip f0100193  args 00000000 00001aac 00000660 00000000 00000000
            kern/init.c:49: i386_init+59
    ebp f010fff8  eip f010003d  args 00000000 00000000 0000ffff 10cf9a00 0000ffff
            kern/entry.S:70: <unknown>+0
    K> 

æ¯ä¸€è¡Œéƒ½ç»™å‡ºäº†stack frame çš„ eip æ–‡ä»¶åå’Œåœ¨è¯¥æ–‡ä»¶ä¸­çš„è¡Œæ•°ï¼Œç„¶åæ˜¯å‡½æ•°çš„åç§°å’Œ eip ä¸å‡½æ•°ç¬¬ä¸€æ¡æŒ‡ä»¤çš„åç§»é‡ï¼ˆä¾‹å¦‚ï¼Œmonitor+106è¡¨ç¤ºè¿”å›eipæ¯”monitorçš„å¼€å¤´å¤š106å­—èŠ‚ï¼‰ã€‚

è¯·ç¡®ä¿å°†æ–‡ä»¶å’Œå‡½æ•°åå•ç‹¬æ‰“å°åœ¨ä¸€è¡Œï¼Œä»¥é¿å…æ··æ·† grading è„šæœ¬ã€‚

æç¤ºï¼šprintfæ ¼å¼çš„å­—ç¬¦ä¸²æä¾›äº†ä¸€ç§ç®€å•ä½†ä¸æ˜æ˜¾çš„æ–¹æ³•æ¥æ‰“å°éç©ºå°¾çš„å­—ç¬¦ä¸²ï¼Œå¦‚STABSè¡¨ä¸­çš„å­—ç¬¦ä¸²ã€‚ printf("%.*s", length, string)æœ€å¤šèƒ½æ‰“å°å‡ºå­—ç¬¦ä¸²çš„é•¿åº¦å­—ç¬¦ã€‚çœ‹ä¸€ä¸‹printfæ‰‹å†Œï¼Œäº†è§£ä¸ºä»€ä¹ˆè¿™æ ·åšã€‚

ä½ å¯èƒ½ä¼šå‘ç°åœ¨å›æº¯ä¸­ç¼ºå°‘ä¸€äº›å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ°å¯¹monitor()çš„è°ƒç”¨ï¼Œä½†æ²¡æœ‰å¯¹runcmd()çš„è°ƒç”¨ã€‚è¿™æ˜¯å› ä¸ºç¼–è¯‘å™¨å¯¹ä¸€äº›å‡½æ•°çš„è°ƒç”¨è¿›è¡Œäº†å†…è”ã€‚å…¶ä»–ä¼˜åŒ–å¯èƒ½å¯¼è‡´ä½ çœ‹åˆ°æ„å¤–çš„è¡Œæ•°ã€‚å¦‚æœä½ æŠŠGNUMakefileä¸­çš„-O2å»æ‰ï¼Œå›æº¯å¯èƒ½ä¼šæ›´æœ‰æ„ä¹‰ï¼ˆä½†ä½ çš„å†…æ ¸ä¼šè¿è¡Œå¾—æ›´æ…¢ï¼‰ã€‚


```cpp
int
mon_backtrace(int argc, char **argv, struct Trapframe *tf)
{
	uint32_t ebp, eip;
	struct Eipdebuginfo info;
	cprintf("Stack backtrace:\n");
	for (ebp = read_ebp(); ebp != 0; ebp = *((uint32_t *)ebp)) {
		eip = *((uint32_t *)ebp + 1);
		cprintf(" ebp %08x eip %08x args %08x %08x %08x %08x %08x\n",
		ebp, eip, *((uint32_t *)ebp + 2),
		*((uint32_t *)ebp + 3), *((uint32_t *)ebp + 4),
		*((uint32_t *)ebp + 5), *((uint32_t *)ebp + 6));

		if (!debuginfo_eip(eip,&info)) {
			cprintf("%s:%d: %.*s+%d\n",
			info.eip_file, info.eip_line,info.eip_fn_namelen,
			info.eip_fn_name, eip - info.eip_fn_addr);		
		}
	}
	return 0;
}
```

