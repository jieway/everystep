# Part 3

接下来会增加一些新的功能，例如 CRC ，删除逻辑。

## CRC 

首先弄清楚 CRC 的作用，随后要弄明白该如何加。编码数据的时候直接将 CRC 附加到字段中即可，解码的时候要根据读取的数据重新生成 CRC 并和之前存的 CRC 比对数据是否一致。

添加一个 CRC (Cyclic Redundancy Check) 字段可以增强数据的完整性和可靠性。CRC 是一种校验码，用于检测数据在传输或存储过程中是否发生了错误。当数据在存储或传输过程中受到干扰或损坏时，CRC 可以帮助检测这些错误，并警示系统发生了数据损坏的情况。这对于确保存储的数据的一致性和可靠性非常重要。

CRC 的作用：
- **数据完整性验证**：通过在数据中添加 CRC 值，接收方可以根据接收到的数据和 CRC 值来验证数据是否完整和正确。如果数据在传输或存储过程中被修改，CRC 校验就会失败，从而通知接收方数据可能已被损坏。

- **错误检测**：CRC 能够检测常见的传输错误，如位翻转、噪声干扰等。它可以捕获一定数量的错误，帮助识别数据是否受损。

- **数据一致性**：在存储系统中，添加 CRC 可以确保存储的数据在长期保存过程中不会被意外更改。如果数据受到未经授权的修改，CRC 检验将失败，提示数据完整性问题。

要将 CRC 字段添加到键值对数据中，你需要执行以下步骤：

1. **计算 CRC 值**：在编码键值对数据之前，计算键值对数据的 CRC 值。这可以通过使用 CRC 算法来实现，例如 CRC32。计算出的 CRC 值将会是一个固定大小的校验码。

2. **编码数据**：在编码键值对数据时，将计算得到的 CRC 值添加到数据中。这可能需要扩展现有的编码和解码函数，以便在编码时添加 CRC，解码时验证 CRC。

3. **解码数据时验证 CRC**：在解码数据时，除了解析出键、值和时间戳之外，还需要解析出 CRC 值。然后，使用相同的 CRC 算法对数据进行校验，以确保数据的完整性。

4. **使用存储时验证 CRC**：在读取数据时，解析出数据和 CRC 值。然后使用 CRC 算法校验数据的完整性。如果 CRC 验证失败，可能意味着数据已被损坏或修改。

请注意，要确保 CRC 的有效性，CRC 值应该与数据一起存储，并且应该在数据存储和传输的每个步骤中进行校验。 CRC 是一种强大的工具，但并不能防止所有类型的数据损坏或攻击，因此还应该综合考虑其他的数据完整性和安全措施。

这个很简单，可以尝试自己能否实现，这是我的实现：[[feat] add crc support.](https://github.com/weijiew/abyssdb/commit/61c8c7790819e97ee65c1784ebc0cf38810f6a41) 。

## 实现删除逻辑

删除逻辑也分为两部分，一部分是内存中，一部分是磁盘上。如果只是删除内存中，这个叫做逻辑删除，将磁盘上的也删掉才真正的物理删除。

删除采用的时逻辑删除，可以简单粗暴的在内存中把 key 对应的 value 抹掉，这样无法从磁盘中查数据了。但是磁盘中依旧有需要被删除的数据该怎么办？接下来是合并操作，通常称为 compaction ，在 LSM Tree 中也有这个东西。首先从头开始读取磁盘文件，根据拿到的数据去哈希表中查找，判断是否被逻辑删除，若被删了则跳过，若没有则创建一张新的哈希表建立新的索引，并把数据写入新的文件中。这样把所有的旧数据都遍历一遍，该删的数据就都删干净了。

## compact
 
